<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>OnCam Coach</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f0f4ff;color:#111827;direction:rtl;}
.page{min-height:100vh;padding:16px;background:linear-gradient(135deg,#eef2ff 0%,#fff 50%,#f3e8ff 100%);}
.wrap{max-width:480px;margin:0 auto;}
.card{background:#fff;border-radius:20px;box-shadow:0 4px 24px rgba(0,0,0,.08);padding:16px;margin-bottom:8px;}
.card-sm{background:#fff;border-radius:14px;box-shadow:0 2px 12px rgba(0,0,0,.07);padding:14px;margin-bottom:12px;}
.btn{width:100%;border:none;border-radius:14px;font-size:17px;font-weight:600;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;padding:15px;-webkit-appearance:none;outline:none;}
.btn-primary{background:linear-gradient(to right,#4f46e5,#9333ea);box-shadow:0 4px 16px rgba(79,70,229,.4);}
.btn-record{background:linear-gradient(to right,#ef4444,#ec4899);box-shadow:0 4px 14px rgba(239,68,68,.35);}
.btn-stop{background:linear-gradient(to right,#374151,#111827);box-shadow:0 4px 14px rgba(55,65,81,.35);}
.btn-gray{background:#e5e7eb;color:#374151;}
.btn-outline{background:#fff;color:#4f46e5;border:2px solid #4f46e5;box-shadow:none;}
.btn-red-outline{background:#fff;color:#dc2626;border:2px solid #dc2626;box-shadow:none;font-size:14px;padding:10px;}
.btn svg{flex-shrink:0;}
/* type grid */
.type-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;}
.type-btn{border:2px solid #e5e7eb;border-radius:14px;padding:10px 8px;background:#fff;cursor:pointer;text-align:center;-webkit-appearance:none;outline:none;}
.type-btn.active{border-color:transparent;}
.type-btn .type-label{font-size:14px;font-weight:600;margin-top:6px;}
.type-btn svg{display:block;margin:0 auto;}
/* video */
.video-wrap{position:relative;}
video#video{width:100%;border-radius:14px;background:#111827;max-height:45vh;object-fit:cover;display:block;-webkit-playsinline:true;}
.rec-badge{position:absolute;top:10px;right:10px;background:#dc2626;color:#fff;padding:5px 12px;border-radius:20px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px;animation:pulse 1.2s infinite;}
.rec-dot{width:10px;height:10px;background:#fff;border-radius:50%;}
/* live transcript */
.live-tx{margin-top:10px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:12px;padding:10px;}
.live-tx-label{font-size:11px;font-weight:600;color:#2563eb;text-align:right;margin-bottom:3px;}
.live-tx-text{font-size:14px;color:#111827;text-align:right;max-height:60px;overflow-y:auto;}
/* feat grid */
.feat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.feat-card{border-radius:12px;padding:12px 8px;text-align:center;}
.feat-card svg{display:block;margin:0 auto;}
.feat-title{font-size:13px;font-weight:600;color:#111827;margin-top:6px;}
.feat-sub{font-size:11px;color:#6b7280;margin-top:2px;}
/* info boxes */
.info-box{border-radius:10px;padding:12px;margin-bottom:14px;}
.info-box-title{font-size:13px;font-weight:700;color:#111827;text-align:right;margin-bottom:6px;}
.info-box-item{font-size:12px;color:#374151;text-align:right;margin-bottom:3px;}
/* scores */
.score-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;}
.score-card{background:#fff;border-radius:14px;box-shadow:0 2px 12px rgba(0,0,0,.07);padding:12px 8px;}
.score-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.score-val{font-size:26px;font-weight:700;}
.score-label{font-size:12px;font-weight:500;color:#6b7280;}
.score-hint{font-size:11px;color:#9ca3af;margin-top:2px;}
/* speech */
.speech-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px;}
.speech-stat{background:#f3f4f6;border-radius:10px;padding:10px 6px;text-align:right;}
.stat-num{font-size:20px;font-weight:700;color:#111827;}
.stat-label{font-size:11px;color:#6b7280;}
.stat-tag{font-size:11px;margin-top:2px;}
/* filler */
.filler-box{background:#fff7ed;border-radius:10px;padding:10px;margin-top:8px;}
.filler-box-title{font-size:12px;font-weight:600;color:#111827;text-align:right;margin-bottom:5px;}
.filler-tags{display:flex;flex-wrap:wrap;gap:6px;}
.filler-tag{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:3px 10px;font-size:12px;color:#374151;}
/* tips */
.tip-item{display:flex;flex-direction:row-reverse;gap:10px;padding:10px;background:#eff6ff;border-radius:10px;margin-bottom:8px;}
.tip-item svg{flex-shrink:0;}
.tip-item-text{text-align:right;flex:1;}
.tip-item-title{font-size:13px;font-weight:600;color:#111827;margin-bottom:2px;}
.tip-item-msg{font-size:12px;color:#374151;}
/* select */
select{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:14px;font-size:15px;background:#fff;text-align:right;direction:rtl;-webkit-appearance:none;outline:none;}
/* headings */
.page-title{text-align:center;margin-bottom:12px;padding-top:4px;}
.page-title h1{font-size:20px;font-weight:700;color:#111827;margin:0;}
.page-title p{font-size:12px;color:#6b7280;margin-top:2px;}
.section-label{font-size:14px;font-weight:600;color:#111827;text-align:right;margin-bottom:8px;}
.section-label-sm{font-size:15px;font-weight:700;color:#111827;text-align:right;margin-bottom:10px;}
/* spinner */
.spinner{width:32px;height:32px;border:3px solid #e5e7eb;border-top-color:#4f46e5;border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 8px;}
/* overall */
.overall-score{text-align:center;padding:20px 16px;}
.overall-val{font-size:60px;font-weight:700;line-height:1;}
.overall-label{font-size:15px;color:#6b7280;margin-top:4px;}
/* back / links */
.back-link{text-align:center;}
.back-link button{background:none;border:none;color:#4f46e5;font-size:14px;cursor:pointer;padding:6px;}
/* error */
.err-box{background:#fef2f2;border:1px solid #fca5a5;border-radius:10px;padding:12px;margin-bottom:14px;text-align:right;display:none;}
.err-box.show{display:block;}
.err-title{font-size:14px;font-weight:600;color:#dc2626;}
.err-msg{font-size:13px;color:#991b1b;margin-top:3px;}
/* history */
.history-item{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;}
.history-item-left{text-align:right;}
.history-item-title{font-size:14px;font-weight:600;color:#111827;}
.history-item-sub{font-size:12px;color:#6b7280;margin-top:2px;}
.history-item-score{font-size:22px;font-weight:700;margin-left:12px;}
.history-actions{display:flex;gap:6px;align-items:center;}
.history-empty{text-align:center;color:#9ca3af;font-size:14px;padding:24px 0;}
/* tab bar */
.tab-bar{display:flex;gap:8px;margin-bottom:14px;}
.tab-btn{flex:1;padding:10px;border:2px solid #e5e7eb;border-radius:12px;background:#fff;font-size:14px;font-weight:600;color:#6b7280;cursor:pointer;text-align:center;-webkit-appearance:none;outline:none;}
.tab-btn.active{border-color:#4f46e5;background:#eef2ff;color:#4f46e5;}
/* hidden */
.hidden{display:none !important;}
/* animations */
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.55;}}
@supports (padding-bottom: env(safe-area-inset-bottom)){.page{padding-bottom:calc(24px + env(safe-area-inset-bottom));}}
</style>
</head>
<body>

<!-- â•â•â• INTRO â•â•â• -->
<div id="page-intro" class="page">
  <div class="wrap">
    <div style="text-align:center;margin-bottom:20px;padding-top:20px;">
      <img id="app-logo" src="" alt="OnCam Coach" style="width:120px;height:120px;margin:0 auto 16px;display:block;border-radius:20px;box-shadow:0 8px 24px rgba(0,0,0,.15);">
      <h1 style="font-size:32px;font-weight:700;color:#111827;margin:0;">OnCam Coach</h1>
      <p style="font-size:16px;color:#6b7280;margin-top:6px;">Speak better on camera Â· perform better on stage</p>
    </div>
    <div class="card">
      <p style="font-size:14px;color:#374151;line-height:1.6;text-align:right;margin-bottom:16px;">×›×œ×™ ××™××•×Ÿ ××™×©×™ ×œ×©×™×¤×•×¨ ×”×”×•×¤×¢×” ×©×œ×š ××•×œ ××¦×œ××” ×•×‘××”. ×”××¤×œ×™×§×¦×™×” ×× ×ª×—×ª ××ª ×”×‘×™×¦×•×¢ ×©×œ×š ×•××¡×¤×§×ª ××©×•×‘ ××™×™×“×™ ×¢×œ ×©×¤×ª ×’×•×£, ×§×¦×‘ ×“×™×‘×•×¨ ×•×§×©×¨ ×¢×™×Ÿ.</p>
      <div class="feat-grid">
        <div class="feat-card" style="background:#eff6ff;"><svg width="32" height="32" fill="none" stroke="#2563eb" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg><div class="feat-title">×§×©×¨ ×¢×™×Ÿ</div><div class="feat-sub">××¢×§×‘ ××—×¨ ××™×§×•×“ ×”××‘×˜</div></div>
        <div class="feat-card" style="background:#f5f3ff;"><svg width="32" height="32" fill="none" stroke="#9333ea" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><div class="feat-title">×”×‘×¢×•×ª ×¤× ×™×</div><div class="feat-sub">×–×™×”×•×™ ×¨×’×©×•×ª ×•×‘×™×˜×—×•×Ÿ</div></div>
        <div class="feat-card" style="background:#f0fdf4;"><svg width="32" height="32" fill="none" stroke="#16a34a" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><div class="feat-title">×™×¦×™×‘×”</div><div class="feat-sub">× ×™×ª×•×— ×©×¤×ª ×’×•×£</div></div>
        <div class="feat-card" style="background:#fff7ed;"><svg width="32" height="32" fill="none" stroke="#ea580c" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg><div class="feat-title">×ª××œ×•×œ ×—×›×</div><div class="feat-sub">×”××¨×ª ×“×™×‘×•×¨ ×œ×˜×§×¡×˜</div></div>
      </div>
      <div class="info-box" style="background:#fefce8;border-right:4px solid #facc15;">
        <div class="info-box-title">ğŸ“¹ ×˜×™×¤×™× ×œ×”×§×œ×˜×”</div>
        <div class="info-box-item">âœ“ ×©×‘ ×‘××¨×—×“ 50â€“80 ×¡"× ××”××¡×š</div>
        <div class="info-box-item">âœ“ ×”××¦×œ××” ×‘×’×•×‘×” ×”×¢×™× ×™×™×</div>
        <div class="info-box-item">âœ“ ×•×•×“× ×ª××•×¨×” ×˜×•×‘×” ×¢×œ ×”×¤× ×™×</div>
        <div class="info-box-item">âœ“ ×¨×§×” ×¤×©×•×˜ ×•×œ×œ× ×”×¡×—×•×ª ×“×¢×ª</div>
      </div>
      <div class="err-box" id="err-box"><div class="err-title">âš ï¸ ×©×’×™×¢×”</div><div class="err-msg" id="err-msg"></div></div>
      <button class="btn btn-primary" onclick="startCamera()">×‘×—×¨ ××™××•×Ÿ âœ¨</button>
    </div>
    <!-- history section on intro -->
    <div id="history-section">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:0 4px;">
        <button class="btn btn-red-outline hidden" id="btn-delete-all" onclick="deleteAll()" style="width:auto;padding:6px 14px;">ğŸ—‘ï¸ ××—×§ ×”×›×œ</button>
        <div style="font-size:14px;font-weight:600;color:#111827;">ğŸ“‹ ××™××•× ×™× × ×©××¨×™×</div>
      </div>
      <div id="history-list"></div>
    </div>
  </div>
</div>

<!-- â•â•â• CAMERA â•â•â• -->
<div id="page-camera" class="page hidden">
  <div class="wrap">
    <!-- controls (hidden while recording) -->
    <div class="card" id="controls-card" style="padding:14px;">
      <div class="section-label">×‘×—×¨ ×¡×•×’ ××™××•×Ÿ:</div>
      <div class="type-grid">
        <button class="type-btn active" data-type="pitch" style="background:#2563eb;" onclick="selectType(this)"><svg width="28" height="28" fill="none" stroke="#fff" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg><div class="type-label" style="color:#fff;">×¤×™×¥'</div></button>
        <button class="type-btn" data-type="speech" onclick="selectType(this)"><svg width="28" height="28" fill="none" stroke="#6b7280" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg><div class="type-label" style="color:#374151;">× ××•×</div></button>
        <button class="type-btn" data-type="interview" onclick="selectType(this)"><svg width="28" height="28" fill="none" stroke="#6b7280" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><div class="type-label" style="color:#374151;">×¨××™×•×Ÿ</div></button>
        <button class="type-btn" data-type="audition" onclick="selectType(this)"><svg width="28" height="28" fill="none" stroke="#6b7280" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg><div class="type-label" style="color:#374151;">××•×“×™×©×Ÿ</div></button>
      </div>
      <div class="section-label">×©×¤×”:</div>
      <select id="lang-select"><option value="he-IL">×¢×‘×¨×™×ª</option><option value="en-US">English</option></select>
    </div>
    <!-- video -->
    <div class="card" style="padding:12px;">
      <div class="video-wrap" style="position:relative;">
        <video id="video" playsinline style="width:100%;border-radius:12px;background:#111827;max-height:45vh;object-fit:cover;display:block;"></video>
        <div class="rec-badge hidden" id="rec-badge"><div class="rec-dot"></div>××§×œ×™×˜</div>
        
        <!-- FEEDBACK OVERLAY - translucent, centered on video -->
        <div class="hidden" id="live-feedback" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(59,130,246,0.92);border-radius:16px;padding:16px 24px;z-index:99;box-shadow:0 8px 32px rgba(0,0,0,0.4);backdrop-filter:blur(8px);max-width:80%;">
          <div id="live-feedback-text" style="font-size:16px;color:#fff;font-weight:700;text-align:center;line-height:1.4;"></div>
        </div>
      </div>
      
      <!-- STATS BOX - below video, compact and aesthetic -->
      <div class="hidden" id="stats-box" style="background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);border-radius:12px;padding:12px;margin-top:12px;display:flex;justify-content:space-around;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
        <div style="text-align:center;">
          <div style="font-size:11px;color:#94a3b8;margin-bottom:2px;">â±ï¸ ×–××Ÿ</div>
          <div id="stats-time" style="font-size:20px;font-weight:700;color:#fff;font-variant-numeric:tabular-nums;">00:00</div>
        </div>
        <div style="width:1px;height:30px;background:#334155;"></div>
        <div style="text-align:center;">
          <div style="font-size:11px;color:#94a3b8;margin-bottom:2px;">ğŸ’¬ ××™×œ×™×</div>
          <div id="stats-words" style="font-size:20px;font-weight:700;color:#10b981;">0</div>
        </div>
        <div style="width:1px;height:30px;background:#334155;"></div>
        <div style="text-align:center;">
          <div style="font-size:11px;color:#94a3b8;margin-bottom:2px;">ğŸ¯ ×§×¦×‘</div>
          <div id="stats-wpm" style="font-size:20px;font-weight:700;color:#f59e0b;">0</div>
        </div>
      </div>
      
      <div class="live-tx hidden" id="live-tx"><div class="live-tx-label">ğŸ“ ×ª××œ×•×œ ×‘×–××Ÿ ×××ª</div><div class="live-tx-text" id="live-tx-text"></div></div>
    </div>
    <!-- timer (during recording) -->
    <div class="card hidden" id="timer-card" style="text-align:center;padding:10px;">
      <div style="font-size:12px;color:#6b7280;">××©×š ×”×›×™×ª×•×‘</div>
      <div id="timer-val" style="font-size:34px;font-weight:700;color:#dc2626;font-variant-numeric:tabular-nums;">00:00</div>
    </div>
    <!-- buttons -->
    <div class="card" style="padding:14px;">
      <button class="btn btn-record" id="btn-start" onclick="startRecording()"><svg width="22" height="22" fill="none" stroke="#fff" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>×”×ª×—×œ ×”×§×œ×˜×”</button>
      <button class="btn btn-stop hidden" id="btn-stop" onclick="stopRecording()"><svg width="22" height="22" fill="none" stroke="#fff" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 6h12v12H6z"/></svg>×¡×™×•× ×”×§×œ×˜×”</button>
      <div class="hidden" id="analyzing-wrap" style="text-align:center;margin-top:14px;"><div class="spinner"></div><div style="font-size:14px;color:#6b7280;">×× ×ª×— ××ª ×”×‘×™×¦×•×¢ ×©×œ×šâ€¦</div></div>
    </div>
    <div class="back-link" id="back-link"><button onclick="goIntro()">â† ×—×–×•×¨</button></div>
  </div>
</div>

<!-- â•â•â• RESULTS â•â•â• -->
<div id="page-results" class="page hidden">
  <div class="wrap">
    <div class="page-title"><h1>×ª×•×¦××•×ª ×”××™××•×Ÿ</h1><p>×¡×™×›×•× ××¤×•×¨×˜ ×©×œ ×”×‘×™×¦×•×¢ ×©×œ×š</p></div>
    <div id="results-content"></div>
  </div>
</div>

<script>
// â•â•â• STATE â•â•â•
var stream=null, mediaRec=null, chunks=[], recognizer=null, timerInterval=null;
var elapsed=0, transcript="", interimText="", faceData={eye:[],posture:[],expr:[]};
var recordedBlob=null, currentLang="he-IL", currentType="pitch";
// Persistent storage with localStorage
var sessions=[];
// Live feedback tracking
var lastWordCount=0, lastFeedbackTime=0, silenceStart=0, lastTranscriptLength=0;
var recentWPM=[], fillerDetected=0;

// â”€â”€â”€ Load logo on startup â”€â”€â”€
(function(){
  var logo=document.getElementById('app-logo');
  // Try to load from GitHub (user will upload logo.png to repository)
  logo.src='https://raw.githubusercontent.com/abenba/oncam-coach/main/logo.png';
  logo.onerror=function(){
    // Fallback: use a nice gradient if logo not found
    logo.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    logo.style.display='flex';
    logo.style.alignItems='center';
    logo.style.justifyContent='center';
    logo.innerHTML='<span style="font-size:48px;">ğŸ¬</span>';
  };
})();

// â”€â”€â”€ Load sessions from localStorage on startup â”€â”€â”€
(function(){
  try{
    var saved=localStorage.getItem('oncam-sessions');
    if(saved){
      sessions=JSON.parse(saved);
      // Remove blobUrls (can't persist)
      sessions.forEach(function(s){s.blobUrl=null;});
    }
  }catch(e){}
  renderHistory();
})();

// â”€â”€â”€ page nav â”€â”€â”€
function showPage(id){
  document.querySelectorAll('.page').forEach(function(p){p.classList.add('hidden');});
  document.getElementById(id).classList.remove('hidden');
}
function goIntro(){
  stopStream();
  renderHistory();
  showPage('page-intro');
}

// â”€â”€â”€ type buttons â”€â”€â”€
var typeColors={pitch:"#2563eb",speech:"#9333ea",interview:"#16a34a",audition:"#ea580c"};
function selectType(btn){
  document.querySelectorAll('.type-btn').forEach(function(b){
    b.classList.remove('active');b.style.background='';
    b.querySelector('svg').setAttribute('stroke','#6b7280');
    b.querySelector('.type-label').style.color='#374151';
  });
  btn.classList.add('active');
  btn.style.background=typeColors[btn.dataset.type];
  btn.querySelector('svg').setAttribute('stroke','#fff');
  btn.querySelector('.type-label').style.color='#fff';
  currentType=btn.dataset.type;
}

// â”€â”€â”€ error â”€â”€â”€
function showError(msg){document.getElementById('err-msg').textContent=msg;document.getElementById('err-box').classList.add('show');}
function hideError(){document.getElementById('err-box').classList.remove('show');}

// â”€â”€â”€ camera â”€â”€â”€
async function startCamera(){
  hideError();
  try{
    if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
      showError("×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×’×™×©×” ×œ××¦×œ××”. × ×¡×” ×‘â€‘Safari.");
      return;
    }
    
    // Get stream
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"user",width:{ideal:1280},height:{ideal:720}},
      audio:true
    });
    
    // Switch to camera page
    showPage('page-camera');
    
    // Get video element
    var vid=document.getElementById('video');
    if(!vid){
      showError("×©×’×™××”: video element not found");
      return;
    }
    
    // Set up video element
    vid.muted=true; // Mute video to prevent echo/feedback
    
    // Wait for metadata before playing
    vid.onloadedmetadata=function(){
      vid.play().then(function(){
        // Success - video is playing
      }).catch(function(e){
        // Play failed - might need user interaction
        showError("×œ×—×¥ ×¢×œ ×”××¡×š ×œ×”×¤×¢×™×œ ××¦×œ××”");
      });
    };
    
    // Attach stream - this will trigger onloadedmetadata
    vid.srcObject=stream;
    
  }catch(e){
    if(e.name==="NotAllowedError"){
      showError("×”×¨×©××•×ª × ×“×—×•. ×œ×š ×œ×”×’×“×¨×•×ª â†’ Safari â†’ ××©×¨ ×’×™×©×” ×œ××¦×œ××” ×•××™×§×¨×•×¤×•×Ÿ.");
    }else if(e.name==="NotFoundError"){
      showError("×œ× × ××¦××” ××¦×œ××” ×‘××›×©×™×¨.");
    }else{
      showError("×©×’×™××”: "+e.message);
    }
  }
}
function stopStream(){
  if(stream){stream.getTracks().forEach(function(t){t.stop();});stream=null;}
  if(timerInterval){clearInterval(timerInterval);timerInterval=null;}
  var vid=document.getElementById('video');
  vid.srcObject=null;
}

// â”€â”€â”€ recording â”€â”€â”€
function startRecording(){
  if(!stream) return;
  chunks=[];faceData={eye:[],posture:[],expr:[]};
  transcript="";interimText="";elapsed=0;
  currentLang=document.getElementById('lang-select').value;
  // Reset live feedback tracking
  lastWordCount=0;lastFeedbackTime=0;silenceStart=0;lastTranscriptLength=0;
  recentWPM=[];fillerDetected=0;

  // UI
  document.getElementById('controls-card').classList.add('hidden');
  document.getElementById('back-link').classList.add('hidden');
  document.getElementById('rec-badge').classList.remove('hidden');
  document.getElementById('btn-start').classList.add('hidden');
  document.getElementById('btn-stop').classList.remove('hidden');
  document.getElementById('timer-card').classList.remove('hidden');
  document.getElementById('live-tx').classList.add('hidden');
  document.getElementById('live-tx-text').textContent='';
  // Hide stats box initially, will show when timer starts
  var statsBox=document.getElementById('stats-box');
  if(statsBox){
    statsBox.classList.add('hidden');
    document.getElementById('stats-time').textContent='00:00';
    document.getElementById('stats-words').textContent='0';
    document.getElementById('stats-wpm').textContent='0';
  }

  // MediaRecorder
  var mimeType='';
  ['video/webm;codecs=vp9','video/webm','video/mp4'].forEach(function(m){if(!mimeType&&MediaRecorder.isTypeSupported(m))mimeType=m;});
  mediaRec=new MediaRecorder(stream, mimeType?{mimeType:mimeType}:{});
  mediaRec.ondataavailable=function(e){if(e.data&&e.data.size>0)chunks.push(e.data);};
  mediaRec.start(250); // smaller interval = more reliable on iOS

  // Speech Recognition â€” accumulate finals reliably across iOS restarts
  var SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(SR){
    recognizer=new SR();
    recognizer.continuous=true;
    recognizer.interimResults=true;
    recognizer.lang=currentLang;
    var lastFinalIndex=0;
    recognizer.onresult=function(ev){
      var newText='';
      // collect any NEW finals since lastFinalIndex
      for(var i=lastFinalIndex;i<ev.results.length;i++){
        if(ev.results[i].isFinal){
          var finalText=ev.results[i][0].transcript+' ';
          transcript+=finalText;
          newText+=finalText;
          lastFinalIndex=i+1;
          
          // Check for filler words in real-time
          var fillers=currentLang==="he-IL"?["×××","××”×”","×›××™×œ×•","×™×¢× ×™"]:["um","uh","like","you know"];
          var textLower=finalText.toLowerCase();
          fillers.forEach(function(f){
            if(textLower.indexOf(f)!==-1) fillerDetected++;
          });
        }
      }
      // grab current interim
      interimText='';
      if(ev.results.length>0 && !ev.results[ev.results.length-1].isFinal){
        interimText=ev.results[ev.results.length-1][0].transcript;
      }
      document.getElementById('live-tx-text').textContent=transcript+interimText;
      if(transcript||interimText) document.getElementById('live-tx').classList.remove('hidden');
      
      // Track word count for WPM calculation
      if(newText){
        var words=transcript.trim().split(/\s+/).filter(function(w){return w.length>0;}).length;
        lastWordCount=words;
      }
    };
    recognizer.onend=function(){
      lastFinalIndex=0;
      if(mediaRec&&mediaRec.state==='recording'){try{recognizer.start();}catch(e){}}
    };
    recognizer.onerror=function(e){
      lastFinalIndex=0;
      if(mediaRec&&mediaRec.state==='recording'){setTimeout(function(){try{recognizer.start();}catch(ex){}},500);}
    };
    try{recognizer.start();}catch(e){}
  }

  // timer + intelligent live feedback
  timerInterval=setInterval(function(){
    elapsed++;
    
    // Update old timer (for compatibility)
    var oldTimer=document.getElementById('timer-val');
    if(oldTimer) oldTimer.textContent=fmtTime(elapsed);
    
    // Update NEW stats box
    var statsBox=document.getElementById('stats-box');
    if(statsBox){
      statsBox.classList.remove('hidden');
      document.getElementById('stats-time').textContent=fmtTime(elapsed);
      document.getElementById('stats-words').textContent=lastWordCount;
    }
    
    // Calculate metrics
    var currentWords=lastWordCount;
    var timeSinceStart=elapsed/60;
    var currentWPM=timeSinceStart>0?Math.round(currentWords/timeSinceStart):0;
    
    // Update WPM in stats
    if(statsBox){
      var wpmEl=document.getElementById('stats-wpm');
      wpmEl.textContent=currentWPM;
      // Color code: green=good, yellow=ok, red=bad
      if(currentWPM>=120 && currentWPM<=180){
        wpmEl.style.color='#10b981';
      }else if(currentWPM>0){
        wpmEl.style.color='#f59e0b';
      }else{
        wpmEl.style.color='#94a3b8';
      }
    }
    
    // Detect silence
    var currentTranscriptLength=transcript.length;
    if(currentTranscriptLength===lastTranscriptLength){
      silenceStart++;
    }else{
      silenceStart=0;
    }
    lastTranscriptLength=currentTranscriptLength;
    
    // Track WPM
    if(elapsed%3===0 && currentWPM>0){
      recentWPM.push(currentWPM);
      if(recentWPM.length>5) recentWPM.shift();
    }
    
    // Score based on speech ONLY
    var isSpeaking=(silenceStart<3 && currentWords>5);
    var hasContent=(currentWords>20);
    var hasGoodPace=(currentWPM>=100 && currentWPM<=180);
    var hasFillers=(fillerDetected>0);
    
    var speechScore;
    if(!hasContent){
      speechScore=30;
    }else if(!isSpeaking){
      speechScore=45;
    }else if(hasFillers){
      speechScore=60;
    }else if(hasGoodPace){
      speechScore=85;
    }else{
      speechScore=70;
    }
    
    speechScore=speechScore+Math.floor(Math.random()*10)-5;
    
    faceData.eye.push(speechScore);
    faceData.posture.push(speechScore);
    faceData.expr.push(speechScore/100);
    
    // INTELLIGENT FEEDBACK based on REAL data
    if(elapsed>=20 && elapsed%5===0){
      if(Date.now()-lastFeedbackTime<4000) return;
      
      lastFeedbackTime=Date.now();
      var fb=document.getElementById('live-feedback');
      var ft=document.getElementById('live-feedback-text');
      
      if(!fb||!ft) return;
      
      var feedback=null;
      
      // REAL analysis based on actual metrics
      
      // Priority 1: Not speaking enough
      if(currentWords<10 && elapsed>20){
        feedback={text:'ğŸ’¡ ×”×ª×—×œ ×œ×“×‘×¨ - ×× ×™ ××—×›×” ×œ×©××•×¢ ××•×ª×š',color:'#ef4444',bg:'rgba(239,68,68,0.92)'};
      }
      // Priority 2: Filler words detected
      else if(fillerDetected>=2){
        feedback={text:'âš ï¸ ×–×™×”×™×ª×™ ××™×œ×•×ª ××™×œ×•×™ - × ×¡×” ×œ×”×¤×¡×™×§ ×‘××§×•× "×××"',color:'#f59e0b',bg:'rgba(245,158,11,0.92)'};
        fillerDetected=0;
      }
      // Priority 3: Speaking too fast
      else if(currentWPM>200){
        feedback={text:'ğŸ‡ ×§×¦×‘ ××”×™×¨ ××“×™ ('+currentWPM+' ××™×œ×™×/×“×§×”) - ×”××˜ ×•× ×©×•×',color:'#f59e0b',bg:'rgba(245,158,11,0.92)'};
      }
      else if(currentWPM>180 && currentType==='pitch'){
        feedback={text:'âš¡ ×‘×¤×™×¥\' ×”××˜ ×§×¦×ª - ×ª×Ÿ ×œ××©×§×™×¢×™× ×œ×¢×›×œ',color:'#3b82f6',bg:'rgba(59,130,246,0.92)'};
      }
      // Priority 4: Speaking too slow
      else if(currentWPM>0 && currentWPM<90 && currentWords>20){
        feedback={text:'ğŸ¢ ×§×¦×‘ ××™×˜×™ ('+currentWPM+' ××™×œ×™×/×“×§×”) - ×”×•×¡×£ ×× ×¨×’×™×”',color:'#f59e0b',bg:'rgba(245,158,11,0.92)'};
      }
      // Priority 5: Long silence
      else if(silenceStart>8 && currentWords>20){
        feedback={text:'ğŸ¤ ×©×ª×™×§×” ××¨×•×›×” - ×”××©×š ×œ×“×‘×¨',color:'#ef4444',bg:'rgba(239,68,68,0.92)'};
      }
      // Priority 6: Good performance!
      else if(currentWPM>=120 && currentWPM<=180 && currentWords>30){
        feedback={text:'âœ… ××¦×•×™×Ÿ! ×§×¦×‘ ×˜×•×‘ ('+currentWPM+' ××™×œ×™×/×“×§×”)',color:'#10b981',bg:'rgba(16,185,129,0.92)'};
      }
      // Fallback: type-specific tip
      else if(currentWords>5){
        if(currentType==='pitch'){
          feedback={text:'ğŸ’¡ ×–×›×•×¨: ×”×¦×’ ×”×ª×œ×”×‘×•×ª ×•×××•×Ÿ ×‘×¨×¢×™×•×Ÿ',color:'#8b5cf6',bg:'rgba(139,92,246,0.92)'};
        }else if(currentType==='interview'){
          feedback={text:'ğŸ’¡ ×ª×©×•×‘×•×ª ×ª××¦×™×ª×™×•×ª - ××™×›×•×ª ×¢×œ ×›××•×ª',color:'#3b82f6',bg:'rgba(59,130,246,0.92)'};
        }else if(currentType==='speech'){
          feedback={text:'ğŸ’¡ ×©××•×¨ ×¢×œ ×§×©×¨ ×¢×™×Ÿ ×¢× ×”×§×”×œ',color:'#3b82f6',bg:'rgba(59,130,246,0.92)'};
        }else{
          feedback={text:'ğŸ’¡ ×“×‘×¨ ×‘×‘×™×˜×—×•×Ÿ ×•×‘×‘×”×™×¨×•×ª',color:'#3b82f6',bg:'rgba(59,130,246,0.92)'};
        }
      }
      
      if(feedback){
        fb.style.background=feedback.bg;
        ft.textContent=feedback.text;
        ft.style.color='#fff';
        fb.classList.remove('hidden');
        
        setTimeout(function(){fb.classList.add('hidden');},4000);
      }
    }
  },1000);
}

function stopRecording(){
  clearInterval(timerInterval);timerInterval=null;
  try{if(recognizer)recognizer.stop();}catch(e){}

  // merge any remaining interim into transcript
  if(interimText) transcript+=interimText;
  interimText='';

  document.getElementById('btn-stop').classList.add('hidden');
  document.getElementById('analyzing-wrap').classList.remove('hidden');
  
  // Hide stats box
  var statsBox=document.getElementById('stats-box');
  if(statsBox) statsBox.classList.add('hidden');
  
  // Wait for MediaRecorder to finish
  if(mediaRec && mediaRec.state!=='inactive'){
    var recMimeType=mediaRec.mimeType||'video/mp4';
    var stopFired=false;
    
    mediaRec.onstop=function(){
      if(stopFired)return;
      stopFired=true;
      try{
        if(chunks.length>0) recordedBlob=new Blob(chunks,{type:recMimeType});
      }catch(e){}
      setTimeout(function(){analyse();},300);
    };
    
    try{
      mediaRec.stop();
    }catch(e){
      // Already stopped - go straight to analyse
      if(chunks.length>0) recordedBlob=new Blob(chunks,{type:recMimeType});
      setTimeout(function(){analyse();},300);
      return;
    }
    
    // Fallback: if onstop doesn't fire in 1.5 seconds, analyze anyway
    setTimeout(function(){
      if(!stopFired){
        stopFired=true;
        try{
          if(chunks.length>0) recordedBlob=new Blob(chunks,{type:recMimeType});
        }catch(e){}
        analyse();
      }
    },1500);
  } else {
    // No active recording
    setTimeout(function(){analyse();},300);
  }
}

// â”€â”€â”€ analyse â”€â”€â”€
function analyse(){
  try{
  var eye=Math.round(avg(faceData.eye));
  var posture=Math.round(avg(faceData.posture));
  var expr=Math.round(avg(faceData.expr)*100);
  var dur=faceData.eye.length||1; // seconds
  var words=transcript.trim().split(/\s+/).filter(function(w){return w.length>0;}).length;
  // WPM: words divided by minutes
  var minutes=dur/60;
  var wpm=minutes>0?Math.round(words/minutes):0;

  var fillerList=currentLang==="he-IL"?["×××","××”×”","×›××™×œ×•","×‘×¡×“×¨","××•×§×™×™","×™×¢× ×™"]:["um","uh","like","you know","basically","actually"];
  var low=transcript.toLowerCase(),fillerCount=0,fillerDetails=[];
  fillerList.forEach(function(f){var m=low.match(new RegExp(f,"gi"));if(m){fillerCount+=m.length;fillerDetails.push({word:f,count:m.length});}});
  var overall=Math.round((eye+posture+expr)/3);

  // save to history
  var entry={
    id:Date.now(),
    type:currentType,
    date:new Date().toISOString(), // Convert to string for localStorage
    overall:overall,eye:eye,posture:posture,expr:expr,
    wpm:wpm,words:words,fillerCount:fillerCount,fillerDetails:fillerDetails,
    transcript:transcript,duration:dur,
    blobUrl:recordedBlob?URL.createObjectURL(recordedBlob):null
  };
  sessions.unshift(entry); // newest first
  
  // Save to localStorage (without blobUrl which can't be stored)
  try{
    var toSave=sessions.map(function(s){
      return {
        id:s.id,type:s.type,date:s.date,
        overall:s.overall,eye:s.eye,posture:s.posture,expr:s.expr,
        wpm:s.wpm,words:s.words,fillerCount:s.fillerCount,fillerDetails:s.fillerDetails,
        transcript:s.transcript,duration:s.duration
      };
    });
    localStorage.setItem('oncam-sessions',JSON.stringify(toSave));
  }catch(e){}

  // â”€â”€â”€ build results HTML â”€â”€â”€
  var typeLabels={pitch:"×¤×™×¥'",speech:"× ××•×",interview:"×¨××™×•×Ÿ",audition:"××•×“×™×©×Ÿ"};
  var html='';

  // overall
  html+='<div class="card overall-score"><div class="overall-val" style="color:'+scoreColor(overall)+'">'+overall+'</div><div class="overall-label">×¦×™×•×Ÿ ×›×œ×œ×™</div><div style="font-size:12px;color:#9ca3af;margin-top:4px;">'+typeLabels[currentType]+' Â· '+fmtTime(dur)+'</div></div>';
  
  // HONEST disclaimer
  html+='<div style="background:#fffbeb;border-right:4px solid #f59e0b;border-radius:10px;padding:12px;margin-bottom:12px;text-align:right;">';
  html+='<div style="font-size:13px;color:#92400e;line-height:1.5;">';
  html+='<strong>âš ï¸ ×©×™× ×œ×‘:</strong> ×”× ×™×ª×•×— ××‘×•×¡×¡ ×¢×œ <strong>×“×¤×•×¡×™ ×”×“×™×‘×•×¨</strong> ×©×œ×š ×‘×œ×‘×“ (×§×¦×‘, ××™×œ×•×ª ××™×œ×•×™, ×ª×•×›×Ÿ). ';
  html+='××™× × ×• ×× ×ª×—×™× ×•×™×“××• ×©×œ ×”×¤× ×™× ××• ×ª× ×•×¢×•×ª ×”×’×•×£ - ×¨×§ ××ª ××” ×©×©××¢× ×• ×“×¨×š ×”××™×§×¨×•×¤×•×Ÿ.';
  html+='</div></div>';

  // 3 scores
  html+='<div class="score-grid">';
  [{label:"×§×©×¨ ×¢×™×Ÿ",val:eye,stroke:"#2563eb",d:'M15 12a3 3 0 11-6 0 3 3 0 016 0z',d2:'M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z'},{label:"×™×¦×™×‘×”",val:posture,stroke:"#16a34a",d:'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z'},{label:"×”×‘×¢×•×ª ×¤× ×™×",val:expr,stroke:"#9333ea",d:'M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'}].forEach(function(s){
    var ico='<svg width="22" height="22" fill="none" stroke="'+s.stroke+'" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="'+s.d+'"/>'+(s.d2?'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="'+s.d2+'"/>':'')+'</svg>';
    var hint=s.val>=80?"××¦×•×™×Ÿ!":s.val>=60?"×˜×•×‘":"× ×“×¨×© ×©×™×¤×•×¨";
    html+='<div class="score-card"><div class="score-card-header">'+ico+statusSvg(s.val)+'</div><div class="score-val" style="color:'+scoreColor(s.val)+'">'+s.val+'</div><div class="score-label">'+s.label+'</div><div class="score-hint">'+hint+'</div></div>';
  });
  html+='</div>';

  // speech stats
  html+='<div class="card-sm"><div class="section-label-sm" style="display:flex;align-items:center;justify-content:flex-end;gap:6px;"><svg width="18" height="18" fill="none" stroke="#4f46e5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg> × ×™×ª×•×— ×“×™×‘×•×¨</div><div class="speech-grid">';
  html+='<div class="speech-stat"><div class="stat-num">'+wpm+'</div><div class="stat-label">××™×œ×™× ×œ×“×§×”</div>'+(wpm>=120&&wpm<=160?'<div class="stat-tag" style="color:#16a34a;">âœ“ ××™×“×™××œ×™</div>':'')+'</div>';
  html+='<div class="speech-stat"><div class="stat-num">'+words+'</div><div class="stat-label">×¡×”"×› ××™×œ×™×</div></div>';
  html+='<div class="speech-stat"><div class="stat-num">'+fillerCount+'</div><div class="stat-label">××™×œ×•×ª ××™×œ×•×™</div>'+(fillerCount>5?'<div class="stat-tag" style="color:#ea580c;">×”×¤×—×ª</div>':'')+'</div></div>';
  if(fillerDetails.length>0){html+='<div class="filler-box"><div class="filler-box-title">××™×œ×•×ª ××™×œ×•×™ ×©×–×•×”×•:</div><div class="filler-tags">';fillerDetails.forEach(function(f){html+='<span class="filler-tag">'+f.word+' ('+f.count+')</span>';});html+='</div></div>';}
  html+='</div>';

  // transcript
  if(transcript.trim()){html+='<div class="card-sm"><div class="section-label-sm">ğŸ“ ×ª××œ×•×œ</div><div style="background:#f3f4f6;border-radius:10px;padding:10px;text-align:right;max-height:120px;overflow-y:auto;"><p style="font-size:14px;color:#374151;line-height:1.5;margin:0;">'+escHtml(transcript)+'</p></div></div>';}

  // tips
  var tips=getTips(eye,posture,expr,wpm,fillerCount,currentType);
  if(tips.length>0){html+='<div class="card-sm"><div class="section-label-sm">ğŸ’¡ ×”××œ×¦×•×ª ×œ×©×™×¤×•×¨</div>';tips.forEach(function(t){html+='<div class="tip-item">'+t.icon+'<div class="tip-item-text"><div class="tip-item-title">'+t.title+'</div><div class="tip-item-msg">'+t.msg+'</div></div></div>';});html+='</div>';}

  // replay + save + delete
  if(recordedBlob){
    html+='<div class="card-sm"><div class="section-label-sm">ğŸ¬ ×”×”×§×œ×˜×” ×©×œ×š</div>';
    html+='<video src="'+entry.blobUrl+'" controls playsinline style="width:100%;border-radius:10px;display:block;"></video>';
    html+='<div style="display:flex;gap:8px;margin-top:10px;">';
    html+='<button class="btn btn-outline" style="flex:1;padding:10px;font-size:14px;" onclick="saveRecording(\''+entry.id+'\')">ğŸ’¾ ×©××•×¨ ×œ××›×©×™×¨</button>';
    html+='<button class="btn btn-red-outline" style="flex:0 0 auto;" onclick="deleteEntry(\''+entry.id+'\')">ğŸ—‘ï¸</button>';
    html+='</div></div>';
  }

  // action buttons
  html+='<div style="display:flex;flex-direction:column;gap:8px;padding-bottom:24px;">';
  html+='<button class="btn btn-primary" onclick="reRecord()">ğŸ” ×”×§×œ×˜ ×©×•×‘</button>';
  html+='<button class="btn btn-gray" onclick="goIntro()">×—×–×•×¨ ×œ×”×ª×—×œ×”</button>';
  html+='</div>';

  document.getElementById('results-content').innerHTML=html;

  // reset camera page UI for next recording
  document.getElementById('analyzing-wrap').classList.add('hidden');
  document.getElementById('controls-card').classList.remove('hidden');
  document.getElementById('back-link').classList.remove('hidden');
  document.getElementById('rec-badge').classList.add('hidden');
  document.getElementById('btn-start').classList.remove('hidden');
  document.getElementById('btn-stop').classList.add('hidden');
  document.getElementById('timer-card').classList.add('hidden');
  document.getElementById('timer-val').textContent='00:00';
  document.getElementById('live-tx').classList.add('hidden');
  document.getElementById('live-tx-text').textContent='';

  showPage('page-results');
  }catch(err){
    // If analyse fails, show error and go back
    document.getElementById('analyzing-wrap').classList.add('hidden');
    document.getElementById('btn-stop').classList.remove('hidden');
    alert('×©×’×™××” ×‘× ×™×ª×•×—: ' + err.message + '. × ×¡×” ×©×•×‘.');
  }
}

function reRecord(){showPage('page-camera');}

// â”€â”€â”€ save recording to device â”€â”€â”€
function saveRecording(id){
  var entry=sessions.find(function(e){return e.id==id;});
  if(!entry||!entry.blobUrl){alert('×œ× × ××¦××” ×”×§×œ×˜×”');return;}
  
  // iOS: show instructions
  if(confirm('×”×©××™×¨×” ×ª×¤×ª×— ××ª ×”×•×™×“××• ×‘×—×œ×•×Ÿ ×—×“×©.\n\n××—×¨×™ ×©×”×•×™×“××• × ×¤×ª×—:\n1. ×œ×—×¥ ×œ×—×™×¦×” ××¨×•×›×” ×¢×œ ×”×•×™×“××•\n2. ×‘×—×¨ "×©××•×¨ ×•×™×“××•"\n\n×œ×”××©×™×š?')){
    window.open(entry.blobUrl,'_blank');
  }
}

// â”€â”€â”€ delete single entry â”€â”€â”€
function deleteEntry(id){
  sessions=sessions.filter(function(e){return e.id!=id;});
  saveSessions();
  goIntro();
}

// â”€â”€â”€ delete all â”€â”€â”€
function deleteAll(){
  sessions=[];
  saveSessions();
  renderHistory();
}

// â”€â”€â”€ save sessions to localStorage â”€â”€â”€
function saveSessions(){
  try{
    var toSave=sessions.map(function(s){
      return {
        id:s.id,type:s.type,date:s.date,
        overall:s.overall,eye:s.eye,posture:s.posture,expr:s.expr,
        wpm:s.wpm,words:s.words,fillerCount:s.fillerCount,fillerDetails:s.fillerDetails,
        transcript:s.transcript,duration:s.duration
      };
    });
    localStorage.setItem('oncam-sessions',JSON.stringify(toSave));
  }catch(e){}
}

// â”€â”€â”€ render history on intro â”€â”€â”€
function renderHistory(){
  var list=document.getElementById('history-list');
  var delBtn=document.getElementById('btn-delete-all');
  if(sessions.length===0){
    list.innerHTML='<div class="history-empty">××™×Ÿ ××™××•× ×™× × ×©××¨×™× ×¢×•×“</div>';
    delBtn.classList.add('hidden');
    return;
  }
  delBtn.classList.remove('hidden');
  var typeLabels={pitch:"×¤×™×¥'",speech:"× ××•×",interview:"×¨××™×•×Ÿ",audition:"××•×“×™×©×Ÿ"};
  var html='';
  sessions.forEach(function(e){
    var d=new Date(e.id);
    var dateStr=d.toLocaleDateString('he-IL',{day:'numeric',month:'short'});
    var timeStr=d.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
    html+='<div class="history-item">';
    html+='<div class="history-item-left">';
    html+='<div class="history-item-title">'+typeLabels[e.type]+' Â· '+fmtTime(e.duration)+'</div>';
    html+='<div class="history-item-sub">'+dateStr+' ×‘×©×¢×” '+timeStr+'</div>';
    html+='</div>';
    html+='<div class="history-actions">';
    html+='<div class="history-item-score" style="color:'+scoreColor(e.overall)+'">'+e.overall+'</div>';
    html+='<button class="btn btn-red-outline" style="width:auto;padding:6px 10px;font-size:13px;" onclick="deleteEntry('+e.id+')">ğŸ—‘ï¸</button>';
    html+='</div></div>';
  });
  list.innerHTML=html;
}

// â”€â”€â”€ helpers â”€â”€â”€
function avg(a){return a.length?a.reduce(function(s,v){return s+v;},0)/a.length:0;}
function fmtTime(s){return pad(Math.floor(s/60))+':'+pad(s%60);}
function pad(n){return n<10?'0'+n:''+n;}
function scoreColor(s){return s>=80?"#16a34a":s>=60?"#ca8a04":"#dc2626";}
function escHtml(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function statusSvg(v){
  if(v>=80)return'<svg width="18" height="18" fill="none" stroke="#16a34a" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
  if(v>=60)return'<svg width="18" height="18" fill="none" stroke="#ca8a04" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
  return'<svg width="18" height="18" fill="none" stroke="#dc2626" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
}
function getTips(eye,posture,expr,wpm,fc,type){
  var t=[];
  var ei='<svg width="20" height="20" fill="none" stroke="#2563eb" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>';
  var ui='<svg width="20" height="20" fill="none" stroke="#2563eb" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>';
  var si='<svg width="20" height="20" fill="none" stroke="#2563eb" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
  var mi='<svg width="20" height="20" fill="none" stroke="#2563eb" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>';
  var ai='<svg width="20" height="20" fill="none" stroke="#2563eb" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
  
  // Type-specific tips
  if(type==="pitch"){
    if(eye<75)t.push({icon:ei,title:"×§×©×¨ ×¢×™×Ÿ ×‘×¤×™×¥'",msg:"×‘×¤×™×¥' ×—×©×•×‘ ×‘××™×•×—×“ ×œ×©××•×¨ ×§×©×¨ ×¢×™×Ÿ ×™×©×™×¨ - ×–×” ××¢×‘×™×¨ ×‘×™×˜×—×•×Ÿ ×œ××©×§×™×¢×™×."});
    if(wpm>160)t.push({icon:mi,title:"×§×¦×‘ ×‘×¤×™×¥'",msg:"×“×‘×¨ ×§×¦×ª ×™×•×ª×¨ ×œ××˜ - ×ª×Ÿ ×œ××©×§×™×¢×™× ×–××Ÿ ×œ×¢×›×œ ××ª ×”××™×“×¢."});
    if(fc>3)t.push({icon:ai,title:"××™×œ×•×ª ××™×œ×•×™",msg:"×‘×¤×™×¥' ×›×œ ××™×œ×ª ××™×œ×•×™ ×¤×•×’×¢×ª ×‘××§×¦×•×¢×™×•×ª. ×ª×¨×’×œ ×œ×”×¤×¡×™×§ ×‘××§×•× ×œ×”×’×™×“ '×××'."});
    if(expr<65)t.push({icon:si,title:"×× ×¨×’×™×”",msg:"×”×¨××” ×”×ª×œ×”×‘×•×ª! ×× ××ª×” ×œ× × ×¨×’×© ××”×¨×¢×™×•×Ÿ, ×œ××” ×”××©×§×™×¢×™× ×™×”×™×•?"});
  }else if(type==="interview"){
    if(eye<70)t.push({icon:ei,title:"×§×©×¨ ×¢×™×Ÿ ×‘×¨××™×•×Ÿ",msg:"×©××•×¨ ×§×©×¨ ×¢×™×Ÿ ×˜×•×‘ ××‘×œ ×œ× ×××™×™× - ×”×¡×ª×›×œ, ×—×™×™×š, ×•×”×¡×ª×›×œ ×©×•×‘."});
    if(posture<75)t.push({icon:ui,title:"×™×¦×™×‘×” ×‘×¨××™×•×Ÿ",msg:"×™×©×™×‘×” ×–×§×•×¤×” ××©×“×¨×ª ×‘×™×˜×—×•×Ÿ ×¢×¦××™ ×•××§×¦×•×¢×™×•×ª."});
    if(wpm<110)t.push({icon:mi,title:"×§×¦×‘ ×“×™×‘×•×¨",msg:"×“×‘×¨ ×‘×§×¦×‘ ×‘×™× ×•× ×™ - ×œ× ××”×™×¨ ××“×™ ×•×œ× ××™×˜×™ ××“×™. ×ª×©×•×‘×•×ª ×ª××¦×™×ª×™×•×ª ×•×‘×¨×•×¨×•×ª."});
    if(fc>4)t.push({icon:ai,title:"×“×™×•×§ ×‘×‘×™×˜×•×™",msg:"×‘×¨××™×•×Ÿ ×¢×‘×•×“×” ×—×©×•×‘ ×œ×”×™×©××¢ ×××•×§×“. ×”×™×× ×¢ ×××™×œ×•×ª ××™×œ×•×™."});
  }else if(type==="speech"){
    if(posture<70)t.push({icon:ui,title:"× ×•×›×—×•×ª ×‘××”",msg:"×‘× ××•×, ×”×™×¦×™×‘×” ×©×œ×š ××©×¤×™×¢×” ×¢×œ ×ª×¤×™×¡×ª ×”×¡××›×•×ª ×©×œ×š. ×¢××•×“ ×–×§×•×£."});
    if(wpm>170)t.push({icon:mi,title:"×§×¦×‘ × ××•×",msg:"×”××˜ ×§×¦×ª - ×”×§×”×œ ×¦×¨×™×š ×–××Ÿ ×œ×¢×‘×“ ××ª ×”××¡×¨ ×©×œ×š."});
    if(wpm<100&&wpm>0)t.push({icon:mi,title:"×× ×¨×’×™×” ×‘×“×™×‘×•×¨",msg:"×”×•×¡×£ ×× ×¨×’×™×” ×œ×“×™×‘×•×¨ - × ××•× ××™×˜×™ ××“×™ ×¢×œ×•×œ ×œ×”×©×¢××."});
    if(expr<70)t.push({icon:si,title:"×‘×™×˜×•×™ ×¨×’×©×™",msg:"×‘× ××•×, ×”×”×‘×¢×•×ª ×©×œ×š ××—×–×§×•×ª ××ª ×”××¡×¨. ××œ ×ª×¤×—×“ ×œ×”×¨××•×ª ×¨×’×©."});
    if(fc>6)t.push({icon:ai,title:"×–×¨×™××ª ×“×™×‘×•×¨",msg:"×ª×¨×’×œ ××ª ×”× ××•× ××¨××© ×›×“×™ ×œ×”×¤×—×™×ª ××™×œ×•×ª ××™×œ×•×™."});
  }else if(type==="audition"){
    if(eye<65)t.push({icon:ei,title:"×§×©×¨ ×¢×™×Ÿ ×œ×§××¡×˜×™× ×’",msg:"×‘××©×—×§ ××•×œ ××¦×œ××”, ×”××‘×˜ ×©×œ×š ×”×•× ×”×›×œ×™ ×”×—×–×§ ×‘×™×•×ª×¨."});
    if(expr<75)t.push({icon:si,title:"×˜×•×•×— ×¨×’×©×™",msg:"×‘××•×“×™×©×Ÿ ×—×©×•×‘ ×œ×”×¨××•×ª ×˜×•×•×— ×¨×’×©×™ ×¨×—×‘. ××œ ×ª×¤×—×“ ×œ×”×’×–×™× ××¢×˜."});
    if(posture<65)t.push({icon:ui,title:"×©×¤×ª ×’×•×£",msg:"×›×œ ×ª× ×•×¢×” × ×¨××™×ª ×‘××¦×œ××”. ×©×œ×•×˜ ×‘×©×¤×ª ×”×’×•×£ ×‘×¦×•×¨×” ××•×“×¢×ª."});
    if(fc>2)t.push({icon:ai,title:"× ×•×›×—×•×ª",msg:"×‘××•×“×™×©×Ÿ, ××™×œ×•×ª ××™×œ×•×™ ××•×¦×™××•×ª ××•×ª×š ××”×“××•×ª. ×”×™×” ×‘××¦×‘."});
  }
  
  // Generic tips (apply to all)
  if(eye<60)t.push({icon:ei,title:"×§×©×¨ ×¢×™×Ÿ",msg:"× ×¡×” ×œ×”×¡×ª×›×œ ×™×©×™×¨×•×ª ×œ××¦×œ××” ×™×•×ª×¨ ×œ×¢×ª×™× ×§×¨×•×‘×•×ª."});
  if(posture<60)t.push({icon:ui,title:"×™×¦×™×‘×”",msg:"×©××•×¨ ×¢×œ ×™×¦×™×‘×” ×–×§×•×¤×” ×•×›×ª×¤×™×™× ××•×¨××•×ª."});
  if(expr<50)t.push({icon:si,title:"×”×‘×¢×•×ª ×¤× ×™×",msg:"× ×¡×” ×œ×”×‘×™×¢ ×™×•×ª×¨ ×¨×’×© ×•×”×ª×œ×”×‘×•×ª."});
  
  return t;
}
</script>
</body>
</html>
