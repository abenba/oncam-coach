<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnCam Coach</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        
        .container { width: 100%; max-width: 500px; }
        
        .page {
            display: none;
            background: white;
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .page.active { display: block; }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 15px;
            font-size: 2em;
            font-weight: 700;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        #video-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        #video {
            width: 100%;
            display: block;
            min-height: 300px;
        }
        
        #timer {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 1.6em;
            font-weight: 700;
        }
        
        #eye-contact {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            display: none;
        }
        
        #eye-contact.warning {
            background: rgba(255, 152, 0, 0.9);
        }
        
        #eye-contact.error {
            background: rgba(231, 76, 60, 0.9);
        }
        
        #stats-box {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px;
            border-radius: 12px;
            display: none;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
        }
        
        .stat-label { color: #aaa; }
        .stat-value { font-weight: 700; margin-right: 15px; }
        
        #wpm-display {
            font-size: 1.3em;
            color: #4CAF50;
        }
        
        #feedback {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 12px;
            font-weight: 600;
            display: none;
        }
        
        #feedback.show { display: block; }
        
        #feedback.good {
            background: #d4edda;
            color: #155724;
        }
        
        #feedback.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        #feedback.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .transcript-box {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .result-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .result-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #667eea;
            margin: 8px 0;
        }
        
        .result-label {
            color: #666;
            font-size: 0.9em;
        }
        
        #overall-score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin: 20px 0;
        }
        
        #overall-score .score {
            font-size: 3.5em;
            font-weight: 800;
        }
        
        .history-item {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .history-info {
            flex: 1;
            cursor: pointer;
        }
        
        .history-date {
            font-size: 0.85em;
            color: #999;
        }
        
        .history-score {
            font-size: 1.8em;
            font-weight: 700;
            color: #667eea;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            font-size: 1.4em;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-btn:active {
            transform: scale(0.95);
            background: #c0392b;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home -->
        <div id="home-page" class="page active">
            <h1>ğŸ¤ OnCam Coach</h1>
            <p class="subtitle">××™××•×Ÿ × ××•××™× ×‘×–××Ÿ ×××ª<br>×¢× ×‘×™× ×” ××œ××›×•×ª×™×ª</p>
            <button class="btn btn-primary" onclick="goToCamera()">ğŸš€ ×”×ª×—×œ ××™××•×Ÿ ×—×“×©</button>
            <button class="btn btn-secondary" onclick="goToHistory()">ğŸ“Š ×”×™×¡×˜×•×¨×™×™×ª ××™××•× ×™×</button>
        </div>

        <!-- Camera -->
        <div id="camera-page" class="page">
            <h1>ğŸ¬ ×”×§×œ×˜×”</h1>
            <div id="video-container">
                <video id="video" autoplay muted playsinline></video>
                <div id="timer">00:00</div>
                <div id="eye-contact">ğŸ‘ï¸ ×§×©×¨ ×¢×™×Ÿ ×˜×•×‘</div>
                <div id="stats-box">
                    <div class="stat-row">
                        <span class="stat-label">â±ï¸ ×–××Ÿ</span>
                        <span class="stat-value" id="stats-time">00:00</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">ğŸ’¬ ××™×œ×™×</span>
                        <span class="stat-value" id="stats-words">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">ğŸ¯ ×§×¦×‘</span>
                        <span class="stat-value"><span id="wpm-display">0</span></span>
                    </div>
                </div>
            </div>
            
            <div id="feedback"></div>
            
            <div class="transcript-box">
                <p id="transcript-text" style="color: #999;">×”×ª××œ×•×œ ×™×•×¤×™×¢ ×›××Ÿ...</p>
            </div>
            
            <button id="start-btn" class="btn btn-primary" onclick="startRecording()">âºï¸ ×”×ª×—×œ ×”×§×œ×˜×”</button>
            <button id="stop-btn" class="btn btn-danger" onclick="stopRecording()" style="display:none;">â¹ï¸ ×¢×¦×•×¨ ×”×§×œ×˜×”</button>
            <button class="btn btn-secondary" onclick="goHome()">ğŸ  ×—×–×•×¨</button>
        </div>

        <!-- Results -->
        <div id="results-page" class="page">
            <h1>ğŸ† ×ª×•×¦××•×ª</h1>
            
            <div id="overall-score">
                <div style="font-size: 1.2em; margin-bottom: 10px;">×¦×™×•×Ÿ ×›×œ×œ×™</div>
                <div class="score" id="final-score">0</div>
                <div style="margin-top: 5px;">××ª×•×š 100</div>
            </div>
            
            <div class="results-grid">
                <div class="result-card">
                    <div class="result-label">××™×œ×™× ×œ×“×§×”</div>
                    <div class="result-value" id="result-wpm">0</div>
                </div>
                <div class="result-card">
                    <div class="result-label">×¡×”"×› ××™×œ×™×</div>
                    <div class="result-value" id="result-words">0</div>
                </div>
                <div class="result-card">
                    <div class="result-label">×–××Ÿ</div>
                    <div class="result-value" id="result-time">0:00</div>
                </div>
                <div class="result-card">
                    <div class="result-label">×§×©×¨ ×¢×™×Ÿ</div>
                    <div class="result-value" id="result-eye" style="font-size: 1.5em;">-</div>
                </div>
            </div>
            
            <div class="transcript-box">
                <strong>×ª××œ×•×œ:</strong><br>
                <span id="result-transcript"></span>
            </div>
            
            <button class="btn btn-primary" onclick="reRecord()">ğŸ”„ ××™××•×Ÿ × ×•×¡×£</button>
            <button class="btn btn-secondary" onclick="goHome()">ğŸ  ×—×–×•×¨</button>
        </div>

        <!-- History -->
        <div id="history-page" class="page">
            <h1>ğŸ“Š ×”×™×¡×˜×•×¨×™×”</h1>
            <div id="history-list"></div>
            <button class="btn btn-secondary" onclick="goHome()">ğŸ  ×—×–×•×¨</button>
        </div>
    </div>

    <script>
        let stream, mediaRecorder, recognition, timerInterval, eyeInterval;
        let startTime, transcript = '', wordCount = 0;
        let wordCountHistory = [], currentWPM = 0;
        let eyeScore = 100, eyeHistory = [];
        let lastWords = 0, silenceCount = 0;
        let faceDetected = true, lastCheck = Date.now();

        function goToCamera() {
            show('camera-page');
            setupCamera();
        }

        function goHome() {
            stopRecording();
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            show('home-page');
        }

        function goToHistory() {
            show('history-page');
            loadHistory();
        }

        function reRecord() {
            show('camera-page');
            resetRecording();
        }

        function show(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        async function setupCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' },
                    audio: true
                });
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                alert('×œ× × ×™×ª×Ÿ ×œ×’×©×ª ×œ××¦×œ××”: ' + err.message);
                goHome();
            }
        }

        function startRecording() {
            if (!stream) return alert('×”××ª×Ÿ ×œ××¦×œ××”...');
            
            transcript = '';
            wordCount = 0;
            wordCountHistory = [];
            currentWPM = 0;
            eyeScore = 100;
            eyeHistory = [];
            lastWords = 0;
            silenceCount = 0;
            
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'block';
            document.getElementById('stats-box').style.display = 'block';
            document.getElementById('eye-contact').style.display = 'block';
            
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            eyeInterval = setInterval(checkEyeContact, 1500);
            
            try {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
            } catch(e) {}
            
            startSpeech();
        }

        function stopRecording() {
            clearInterval(timerInterval);
            clearInterval(eyeInterval);
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            if (recognition) {
                recognition.stop();
                recognition = null;
            }
            
            document.getElementById('stats-box').style.display = 'none';
            document.getElementById('eye-contact').style.display = 'none';
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('stop-btn').style.display = 'none';
            
            setTimeout(showResults, 500);
        }

        function resetRecording() {
            transcript = '';
            wordCount = 0;
            document.getElementById('transcript-text').textContent = '×”×ª××œ×•×œ ×™×•×¤×™×¢ ×›××Ÿ...';
            document.getElementById('timer').textContent = '00:00';
        }

        function startSpeech() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return;
            
            recognition = new SR();
            recognition.lang = 'he-IL';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            recognition.onresult = (e) => {
                let final = '', interim = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    if (e.results[i].isFinal) {
                        final += e.results[i][0].transcript + ' ';
                    } else {
                        interim += e.results[i][0].transcript;
                    }
                }
                
                if (final) {
                    transcript += final;
                    const words = transcript.trim().split(/\s+/).filter(w => w.length > 0);
                    wordCount = words.length;
                }
                
                const display = transcript + (interim ? '<i style="color:#999">' + interim + '</i>' : '');
                document.getElementById('transcript-text').innerHTML = display || '××§×œ×™×˜...';
            };
            
            recognition.onerror = (e) => {
                if (e.error !== 'no-speech') {
                    console.error('Speech error:', e.error);
                }
            };
            
            recognition.onend = () => {
                if (timerInterval) {
                    try { recognition.start(); } catch(e) {}
                }
            };
            
            try {
                recognition.start();
            } catch(e) {
                console.error('Speech start error:', e);
            }
        }

        function checkEyeContact() {
            const video = document.getElementById('video');
            const indicator = document.getElementById('eye-contact');
            
            if (!video.videoWidth) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = 160;
            canvas.height = 120;
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            
            let sum = 0;
            for (let i = 0; i < data.length; i += 4) {
                sum += data[i] + data[i+1] + data[i+2];
            }
            const brightness = sum / (data.length * 3 / 4);
            
            // ××ª×—×•×œ ×¨××©×•×Ÿ
            if (!window.lastBrightness) {
                window.lastBrightness = brightness;
                window.stableCount = 0;
                return;
            }
            
            const change = Math.abs(brightness - window.lastBrightness);
            
            // ×× ×”×‘×”×™×¨×•×ª ×›××¢×˜ ×œ× ××©×ª× ×” - ××¦×‘ ×—×©×•×“
            if (change < 1) {
                window.stableCount = (window.stableCount || 0) + 1;
                
                // ×¨×§ ××—×¨×™ 3 ×‘×“×™×§×•×ª ×¨×¦×•×¤×•×ª ×©×œ "×§×™×¤××•×Ÿ" - ××ª×¨×™×¢×™×
                if (window.stableCount >= 3) {
                    eyeScore = Math.max(0, eyeScore - 5);
                    indicator.textContent = 'âš ï¸ ×—×–×•×¨ ×œ××¡×š!';
                    indicator.className = 'warning';
                    
                    // ×”×ª×¨××” ×¨×§ ××—×ª ×œ×›×œ 10 ×©× ×™×•×ª
                    const now = Date.now();
                    if (!window.lastAlert || now - window.lastAlert > 10000) {
                        showFeedback('× ×¨××” ×©×™×¦××ª ××”××¡×š! ğŸ‘€', 'warning');
                        window.lastAlert = now;
                    }
                }
            } else if (change < 8) {
                // ×©×™× ×•×™ ×§×˜×Ÿ - ×§×©×¨ ×¢×™×Ÿ ×¡×‘×™×¨
                window.stableCount = 0;
                eyeScore = Math.min(100, eyeScore + 1);
                indicator.textContent = 'ğŸ‘ï¸ ×§×©×¨ ×¢×™×Ÿ ×¡×‘×™×¨';
                indicator.className = '';
            } else {
                // ×©×™× ×•×™ ××©××¢×•×ª×™ - ×§×©×¨ ×¢×™×Ÿ ×˜×•×‘!
                window.stableCount = 0;
                eyeScore = Math.min(100, eyeScore + 2);
                indicator.textContent = 'âœ… ×§×©×¨ ×¢×™×Ÿ ××¦×•×™×Ÿ!';
                indicator.className = '';
            }
            
            window.lastBrightness = brightness;
            eyeHistory.push(eyeScore);
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('timer').textContent = 
                `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
            
            calcWPM(elapsed);
            updateStats(elapsed);
            
            if (elapsed % 3 === 0) checkFeedback(elapsed);
        }

        function calcWPM(elapsed) {
            wordCountHistory.push({ time: elapsed, words: wordCount });
            wordCountHistory = wordCountHistory.filter(e => e.time > elapsed - 30);
            
            const window15 = wordCountHistory.filter(e => e.time >= elapsed - 15);
            
            if (window15.length >= 2 && elapsed >= 10) {
                const old = window15[0];
                const cur = window15[window15.length - 1];
                const diff = cur.time - old.time;
                const words = cur.words - old.words;
                if (diff > 0 && words > 0) {
                    currentWPM = Math.round((words / diff) * 60);
                }
            } else if (elapsed >= 3 && wordCount > 0) {
                currentWPM = Math.round((wordCount / elapsed) * 60);
            } else {
                currentWPM = 0;
            }
        }

        function updateStats(elapsed) {
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('stats-time').textContent = 
                `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
            document.getElementById('stats-words').textContent = wordCount;
            
            const wpm = document.getElementById('wpm-display');
            wpm.textContent = currentWPM;
            if (currentWPM >= 120 && currentWPM <= 180) {
                wpm.style.color = '#4CAF50';
            } else if (currentWPM > 0) {
                wpm.style.color = '#FF9800';
            } else {
                wpm.style.color = '#999';
            }
        }

        function checkFeedback(elapsed) {
            if (elapsed < 10) return;
            
            if (wordCount === lastWords) {
                silenceCount++;
            } else {
                silenceCount = 0;
                lastWords = wordCount;
            }
            
            if (silenceCount > 8 && wordCount > 20) {
                showFeedback('×©×ª×™×§×” ××¨×•×›×” - ×”××©×š ×œ×“×‘×¨! ğŸ¤', 'error');
            } else if (currentWPM > 0 && currentWPM < 100) {
                showFeedback(`×§×¦×‘ ××™×˜×™ (${currentWPM}) - ×”××¥ ×§×¦×ª âš¡`, 'warning');
            } else if (currentWPM > 200) {
                showFeedback(`×§×¦×‘ ××”×™×¨ (${currentWPM}) - ×”××˜ ××¢×˜ ğŸ¢`, 'warning');
            } else if (currentWPM >= 120 && currentWPM <= 180) {
                showFeedback(`××¦×•×™×Ÿ! (${currentWPM} WPM) ğŸ¯`, 'good');
            }
        }

        function showFeedback(msg, type) {
            const f = document.getElementById('feedback');
            f.textContent = msg;
            f.className = 'show ' + type;
            if (type === 'good') {
                setTimeout(() => f.classList.remove('show'), 3000);
            }
        }

        function showResults() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const mins = elapsed / 60;
            const wpm = mins > 0 ? Math.round(wordCount / mins) : 0;
            
            let score = 0;
            if (wpm >= 120 && wpm <= 180) score += 50;
            else if (wpm >= 100) score += 40;
            else if (wpm >= 80) score += 30;
            else if (wpm > 0) score += 20;
            
            if (wordCount >= 100) score += 30;
            else if (wordCount >= 50) score += 20;
            else if (wordCount >= 20) score += 10;
            
            if (elapsed >= 60) score += 20;
            else if (elapsed >= 30) score += 10;
            
            const avgEye = eyeHistory.length > 0 
                ? Math.round(eyeHistory.reduce((a,b)=>a+b,0) / eyeHistory.length) 
                : 100;
            
            let eyeLabel = avgEye >= 80 ? '××¦×•×™×Ÿ âœ¨' : 
                          avgEye >= 60 ? '×˜×•×‘ ğŸ‘' :
                          avgEye >= 40 ? '×‘×¡×“×¨ ğŸ‘Œ' : '×—×œ×© âš ï¸';
            
            document.getElementById('final-score').textContent = score;
            document.getElementById('result-wpm').textContent = wpm;
            document.getElementById('result-words').textContent = wordCount;
            document.getElementById('result-time').textContent = 
                `${Math.floor(elapsed/60)}:${String(elapsed%60).padStart(2,'0')}`;
            document.getElementById('result-eye').textContent = eyeLabel;
            document.getElementById('result-transcript').textContent = transcript || '××™×Ÿ ×ª××œ×•×œ';
            
            saveHistory(score, wpm, wordCount, elapsed, eyeLabel, transcript);
            show('results-page');
        }

        function saveHistory(score, wpm, words, time, eye, trans) {
            let hist = JSON.parse(localStorage.getItem('oncam') || '[]');
            const newSession = {
                id: Date.now(),
                date: new Date().toLocaleString('he-IL'),
                score, wpm, words, time, eye, trans
            };
            hist.unshift(newSession);
            if (hist.length > 50) hist = hist.slice(0, 50);
            localStorage.setItem('oncam', JSON.stringify(hist));
            console.log('[HISTORY] Saved session:', newSession);
            console.log('[HISTORY] Total sessions:', hist.length);
        }

        function loadHistory() {
            const hist = JSON.parse(localStorage.getItem('oncam') || '[]');
            const list = document.getElementById('history-list');
            
            console.log('[HISTORY] Found', hist.length, 'sessions');
            
            if (hist.length === 0) {
                list.innerHTML = '<div class="empty-state"><div style="font-size:3em">ğŸ“­</div><div>××™×Ÿ ××™××•× ×™× ×©××•×¨×™×</div></div>';
                return;
            }
            
            list.innerHTML = hist.map(h => `
                <div class="history-item">
                    <button class="delete-btn" onclick="event.stopPropagation(); deleteHistory(${h.id})">ğŸ—‘ï¸</button>
                    <div class="history-info" onclick="viewHistory(${h.id})" style="cursor: pointer;">
                        <div class="history-date">${h.date}</div>
                        <div>${h.wpm} WPM Â· ${h.words} ××™×œ×™× Â· ${Math.floor(h.time/60)}:${String(h.time%60).padStart(2,'0')}</div>
                    </div>
                    <div class="history-score">${h.score}</div>
                </div>
            `).join('');
        }

        function deleteHistory(id) {
            event.stopPropagation(); // ×¢×¦×•×¨ ××ª ×”×œ×—×™×¦×” ××œ×”×ª×¤×©×˜
            if (!confirm('×œ××—×•×§ ××™××•×Ÿ ×–×”?')) return;
            let hist = JSON.parse(localStorage.getItem('oncam') || '[]');
            hist = hist.filter(h => h.id !== id);
            localStorage.setItem('oncam', JSON.stringify(hist));
            loadHistory();
        }

        function viewHistory(id) {
            const hist = JSON.parse(localStorage.getItem('oncam') || '[]');
            const h = hist.find(x => x.id === id);
            if (!h) return;
            
            document.getElementById('final-score').textContent = h.score;
            document.getElementById('result-wpm').textContent = h.wpm;
            document.getElementById('result-words').textContent = h.words;
            document.getElementById('result-time').textContent = 
                `${Math.floor(h.time/60)}:${String(h.time%60).padStart(2,'0')}`;
            document.getElementById('result-eye').textContent = h.eye;
            document.getElementById('result-transcript').textContent = h.trans || '××™×Ÿ ×ª××œ×•×œ';
            
            show('results-page');
        }
    </script>
</body>
</html>
