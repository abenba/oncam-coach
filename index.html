<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnCam Coach -  </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }
        
        .page {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .page.active {
            display: block;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        #video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #video {
            width: 100%;
            display: block;
        }
        
        #timer {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        #stats-box {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9em;
            min-width: 200px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .stat-label {
            color: #aaa;
        }
        
        .stat-value {
            font-weight: bold;
            color: white;
        }
        
        #wpm-display {
            font-size: 1.3em;
            color: #4CAF50;
        }
        
        #feedback {
            text-align: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }
        
        #feedback.show {
            display: block;
        }
        
        #feedback.good {
            background: #d4edda;
            color: #155724;
        }
        
        #feedback.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        #feedback.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .transcript-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            direction: rtl;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .result-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .result-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .result-label {
            color: #666;
            font-size: 0.9em;
        }
        
        #overall-score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }
        
        #overall-score .score {
            font-size: 3em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Page -->
        <div id="home-page" class="page active">
            <h1> OnCam Coach</h1>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                  住住 AI<br>
                砖驻专 转 砖专 专 砖
            </p>
            <button class="btn btn-primary" onclick="goToCamera()">转  砖</button>
            <button class="btn btn-secondary" onclick="alert('拽专!')">住专转 </button>
        </div>

        <!-- Camera Page -->
        <div id="camera-page" class="page">
            <h1> 拽</h1>
            
            <div id="video-container">
                <video id="video" autoplay muted playsinline></video>
                <div id="timer">00:00</div>
                <div id="stats-box" style="display:none;">
                    <div class="stat-row">
                        <span class="stat-label">憋 :</span>
                        <span class="stat-value" id="stats-time">00:00</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label"> :</span>
                        <span class="stat-value" id="stats-words">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label"> 拽爪:</span>
                        <span class="stat-value" id="stats-wpm">
                            <span id="wpm-display">0</span>
                        </span>
                    </div>
                </div>
            </div>
            
            <div id="feedback"></div>
            
            <div class="transcript-box" id="transcript-box">
                <p id="transcript-text" style="color: #999;">转 驻注 ...</p>
            </div>
            
            <button id="start-btn" class="btn btn-primary" onclick="startRecording()">转 拽</button>
            <button id="stop-btn" class="btn btn-danger" onclick="stopRecording()" style="display:none;">注爪专 拽</button>
            <button class="btn btn-secondary" onclick="goHome()">专</button>
        </div>

        <!-- Results Page -->
        <div id="results-page" class="page">
            <h1> 转爪转</h1>
            
            <div id="overall-score">
                <div style="font-size: 1.2em; margin-bottom: 10px;">爪 </div>
                <div class="score" id="final-score">0</div>
                <div style="margin-top: 10px;">转 100</div>
            </div>
            
            <div class="results-grid">
                <div class="result-card">
                    <div class="result-label"> 拽</div>
                    <div class="result-value" id="result-wpm">0</div>
                </div>
                <div class="result-card">
                    <div class="result-label">住" </div>
                    <div class="result-value" id="result-words">0</div>
                </div>
                <div class="result-card">
                    <div class="result-label"> </div>
                    <div class="result-value" id="result-time">0:00</div>
                </div>
                <div class="result-card">
                    <div class="result-label">砖祝 专</div>
                    <div class="result-value" id="result-fluency">-</div>
                </div>
            </div>
            
            <div class="transcript-box">
                <h3 style="margin-bottom: 10px;">转 :</h3>
                <p id="result-transcript"></p>
            </div>
            
            <button class="btn btn-primary" onclick="reRecord()"> 住祝</button>
            <button class="btn btn-secondary" onclick="goHome()">专 注 转</button>
        </div>
    </div>

    <script>
        // Global variables
        let stream = null;
        let mediaRecorder = null;
        let recognition = null;
        let recordedChunks = [];
        let startTime = null;
        let timerInterval = null;
        let transcript = '';
        let wordCount = 0;
        let wordCountHistory = [];
        let currentWPM = 0;
        let silenceStart = 0;
        let lastSilenceCheckWords = 0;

        // Navigation
        function goToCamera() {
            document.getElementById('home-page').classList.remove('active');
            document.getElementById('camera-page').classList.add('active');
            setupCamera();
        }

        function goHome() {
            stopRecording();
            document.getElementById('camera-page').classList.remove('active');
            document.getElementById('results-page').classList.remove('active');
            document.getElementById('home-page').classList.add('active');
        }

        function reRecord() {
            document.getElementById('results-page').classList.remove('active');
            document.getElementById('camera-page').classList.add('active');
            resetRecording();
        }

        // Camera setup
        async function setupCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' }, 
                    audio: true 
                });
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                console.error('砖 砖 爪:', err);
                alert(' 转 砖转 爪.  拽 转 专砖转.');
            }
        }

        // Recording functions
        function startRecording() {
            console.log('Starting recording...');
            
            // Reset variables
            transcript = '';
            wordCount = 0;
            wordCountHistory = [];
            currentWPM = 0;
            silenceStart = 0;
            lastSilenceCheckWords = 0;
            recordedChunks = [];
            
            // Update UI
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'block';
            document.getElementById('transcript-text').textContent = '拽...';
            document.getElementById('transcript-text').style.color = '#333';
            document.getElementById('feedback').classList.remove('show');
            
            // Show stats box
            const statsBox = document.getElementById('stats-box');
            statsBox.style.display = 'block';
            
            // Start timer
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            
            // Start video recording
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            mediaRecorder.start();
            
            // Start speech recognition
            startSpeechRecognition();
        }

        function stopRecording() {
            console.log('Stopping recording...');
            
            // Stop timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Stop video recording
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            // Stop speech recognition
            if (recognition) {
                recognition.stop();
            }
            
            // Hide stats box
            const statsBox = document.getElementById('stats-box');
            if (statsBox) {
                statsBox.style.display = 'none';
            }
            
            // Calculate results
            calculateResults();
            
            // Update UI
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('stop-btn').style.display = 'none';
        }

        function resetRecording() {
            transcript = '';
            wordCount = 0;
            wordCountHistory = [];
            currentWPM = 0;
            recordedChunks = [];
            document.getElementById('transcript-text').textContent = '转 驻注 ...';
            document.getElementById('transcript-text').style.color = '#999';
            document.getElementById('timer').textContent = '00:00';
            document.getElementById('feedback').classList.remove('show');
        }

        // Speech recognition
        function startSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.error('Speech recognition not supported');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'he-IL';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcriptPiece = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcriptPiece + ' ';
                    } else {
                        interimTranscript += transcriptPiece;
                    }
                }
                
                if (finalTranscript) {
                    transcript += finalTranscript;
                    wordCount = transcript.trim().split(/\s+/).filter(w => w.length > 0).length;
                    console.log('[SPEECH] New words:', wordCount);
                }
                
                // Update display
                const displayText = transcript + (interimTranscript ? '<i style="color: #999;">' + interimTranscript + '</i>' : '');
                document.getElementById('transcript-text').innerHTML = displayText || '拽...';
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
            };
            
            recognition.onend = () => {
                console.log('Speech recognition ended');
            };
            
            recognition.start();
        }

        // Timer and stats update
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            document.getElementById('timer').textContent = timeString;
            
            // Calculate WPM
            calculateWPM(elapsed);
            
            // Update stats display
            updateStatsDisplay(elapsed, wordCount, currentWPM);
            
            // Check for feedback
            checkFeedback(elapsed);
        }

        function calculateWPM(elapsed) {
            const currentWords = wordCount;
            
            // Add current word count to history
            wordCountHistory.push({ time: elapsed, words: currentWords });
            
            // Keep only last 30 seconds of history
            wordCountHistory = wordCountHistory.filter(entry => entry.time > elapsed - 30);
            
            // Calculate WPM using sliding window (last 15 seconds)
            const windowStart = elapsed - 15;
            const windowEntries = wordCountHistory.filter(entry => entry.time >= windowStart);
            
            if (windowEntries.length >= 2 && elapsed >= 10) {
                const oldEntry = windowEntries[0];
                const newEntry = windowEntries[windowEntries.length - 1];
                const timeDiff = newEntry.time - oldEntry.time;
                const wordDiff = newEntry.words - oldEntry.words;
                
                if (timeDiff > 0) {
                    currentWPM = Math.round((wordDiff / timeDiff) * 60);
                    console.log(`[WPM] Sliding window: ${wordDiff} words in ${timeDiff}s = ${currentWPM} WPM`);
                }
            }
            // Fallback: calculate from start (for first 10 seconds or if no sliding window data)
            else if (elapsed >= 3 && currentWords > 0) {
                currentWPM = Math.round((currentWords / elapsed) * 60);
                console.log(`[WPM] Early calc: ${currentWords} words in ${elapsed}s = ${currentWPM} WPM`);
            }
            // Very early stage - estimate if we have any words
            else if (currentWords > 0 && elapsed > 0) {
                currentWPM = Math.round((currentWords / elapsed) * 60);
            }
            else {
                currentWPM = 0;
            }
        }

        function updateStatsDisplay(elapsed, words, wpm) {
            const statsTimeEl = document.getElementById('stats-time');
            const statsWordsEl = document.getElementById('stats-words');
            const statsWpmEl = document.getElementById('wpm-display');
            
            if (statsTimeEl) {
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                statsTimeEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            if (statsWordsEl) {
                statsWordsEl.textContent = words;
            }
            
            if (statsWpmEl) {
                statsWpmEl.textContent = wpm;
                
                // Color coding
                if (wpm === 0) {
                    statsWpmEl.style.color = '#999';
                } else if (wpm >= 120 && wpm <= 180) {
                    statsWpmEl.style.color = '#4CAF50'; // Green - perfect
                } else if (wpm < 120 || wpm > 180) {
                    statsWpmEl.style.color = '#FF9800'; // Orange - needs adjustment
                }
                
                console.log(`[STATS] Updated: Time=${statsTimeEl.textContent} Words=${words} WPM=${wpm}`);
            }
        }

        function checkFeedback(elapsed) {
            // Don't show feedback in first 10 seconds
            if (elapsed < 10) return;
            
            const feedbackEl = document.getElementById('feedback');
            
            // Check for silence (no new words in 25 seconds)
            const wordsAddedRecently = (wordCount > lastSilenceCheckWords);
            if (!wordsAddedRecently && wordCount > 10) {
                silenceStart++;
            } else {
                silenceStart = 0;
                lastSilenceCheckWords = wordCount;
            }
            
            console.log(`[FEEDBACK] Check @${elapsed}s | WPM:${currentWPM} | Words:${wordCount} | History:${wordCountHistory.length}`);
            
            // Show feedback based on WPM and silence
            if (silenceStart > 25 && wordCount > 30) {
                showFeedback('砖转拽 专 - 砖 专!', 'error');
                console.log('[FEEDBACK] Showing: Long silence');
            }
            else if (currentWPM > 0 && currentWPM < 100) {
                showFeedback(`拽爪   (${currentWPM} WPM) - 住 抓`, 'warning');
                console.log(`[FEEDBACK] Showing: Too slow - ${currentWPM} WPM`);
            }
            else if (currentWPM > 200) {
                showFeedback(`拽爪 专  (${currentWPM} WPM) -  拽爪转`, 'warning');
                console.log(`[FEEDBACK] Showing: Too fast - ${currentWPM} WPM`);
            }
            else if (currentWPM >= 120 && currentWPM <= 180) {
                showFeedback(`爪! 拽爪  (${currentWPM} WPM)`, 'good');
                console.log(`[FEEDBACK] Showing: Perfect pace - ${currentWPM} WPM`);
            }
            else if (currentWPM > 0) {
                showFeedback('砖注 转!', 'good');
                console.log('[FEEDBACK] Showing: Listening');
            }
        }

        function showFeedback(message, type) {
            const feedbackEl = document.getElementById('feedback');
            feedbackEl.textContent = message;
            feedbackEl.className = 'show ' + type;
        }

        // Results calculation
        function calculateResults() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = elapsed / 60;
            
            // Calculate final WPM
            const finalWPM = Math.round(wordCount / minutes);
            
            // Calculate score (0-100)
            let score = 0;
            
            // WPM score (50 points)
            if (finalWPM >= 120 && finalWPM <= 180) {
                score += 50;
            } else if (finalWPM >= 100 && finalWPM < 120) {
                score += 40;
            } else if (finalWPM > 180 && finalWPM <= 200) {
                score += 40;
            } else if (finalWPM >= 80 && finalWPM < 100) {
                score += 30;
            } else {
                score += 20;
            }
            
            // Word count score (30 points)
            if (wordCount >= 100) {
                score += 30;
            } else if (wordCount >= 50) {
                score += 20;
            } else {
                score += 10;
            }
            
            // Duration score (20 points)
            if (elapsed >= 60) {
                score += 20;
            } else if (elapsed >= 30) {
                score += 10;
            } else {
                score += 5;
            }
            
            // Fluency rating
            let fluency = '';
            if (finalWPM >= 120 && finalWPM <= 180) {
                fluency = '注';
            } else if (finalWPM >= 100 && finalWPM < 120) {
                fluency = '';
            } else if (finalWPM < 100) {
                fluency = '';
            } else {
                fluency = '专';
            }
            
            // Update results page
            document.getElementById('final-score').textContent = score;
            document.getElementById('result-wpm').textContent = finalWPM;
            document.getElementById('result-words').textContent = wordCount;
            document.getElementById('result-time').textContent = `${Math.floor(elapsed / 60)}:${String(elapsed % 60).padStart(2, '0')}`;
            document.getElementById('result-fluency').textContent = fluency;
            document.getElementById('result-transcript').textContent = transcript || ' 拽 转';
            
            // Show results page
            document.getElementById('camera-page').classList.remove('active');
            document.getElementById('results-page').classList.add('active');
            
            console.log(`[RESULTS] Score:${score} WPM:${finalWPM} Words:${wordCount} Time:${elapsed}s`);
        }
    </script>
</body>
</html>
