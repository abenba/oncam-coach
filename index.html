<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>OnCam Coach</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        .container { width: 100%; max-width: 500px; }
        .page { display: none; background: white; border-radius: 25px; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .page.active { display: block; }
        h1 { color: #667eea; text-align: center; margin-bottom: 15px; font-size: 2em; font-weight: 700; }
        .subtitle { 
            text-align: center; 
            margin-bottom: 35px; 
            line-height: 1.8;
        }
        .subtitle-question {
            font-size: 1.1em;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .subtitle-answer {
            font-size: 1.05em;
            color: #555;
            font-weight: 500;
        }
        .btn { width: 100%; padding: 18px; margin: 12px 0; border: none; border-radius: 15px; font-size: 1.1em; font-weight: 600; cursor: pointer; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-danger { background: #e74c3c; color: white; }
        #video-container { position: relative; background: #000; border-radius: 15px; overflow: hidden; margin-bottom: 30px; }
        #video { width: 100%; display: block; min-height: 300px; }
        #timer { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); color: white; padding: 12px 20px; border-radius: 12px; font-size: 1.6em; font-weight: 700; }
        #eye-contact { position: absolute; top: 15px; right: 15px; background: rgba(76, 175, 80, 0.9); color: white; padding: 10px 16px; border-radius: 12px; font-size: 1.1em; font-weight: 600; display: none; }
        #eye-contact.warning { background: rgba(255, 152, 0, 0.9); }
        #eye-contact.error { background: rgba(231, 76, 60, 0.9); }
        #stats-box { position: absolute; bottom: 15px; right: 15px; background: rgba(0,0,0,0.85); color: white; padding: 15px; border-radius: 12px; display: none; }
        .stat-row { display: flex; justify-content: space-between; margin: 6px 0; }
        .stat-label { color: #aaa; }
        .stat-value { font-weight: 700; margin-right: 15px; }
        #wpm-display { font-size: 1.3em; color: #4CAF50; }
        #feedback { text-align: center; padding: 15px; margin: 15px 0; border-radius: 12px; font-weight: 600; display: none; }
        #feedback.show { display: block; }
        #feedback.good { background: #d4edda; color: #155724; }
        #feedback.warning { background: #fff3cd; color: #856404; }
        #feedback.error { background: #f8d7da; color: #721c24; }
        .transcript-box { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 15px; margin: 15px 0; max-height: 150px; overflow-y: auto; }
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .result-card { background: #f8f9fa; padding: 20px; border-radius: 15px; text-align: center; }
        .result-value { font-size: 2.2em; font-weight: 700; color: #667eea; margin: 8px 0; }
        .result-label { color: #666; font-size: 0.9em; }
        .summary-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin: 25px 0;
            text-align: center;
        }
        .summary-title {
            color: #667eea;
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 12px;
        }
        .summary-text {
            color: #555;
            font-size: 1em;
            line-height: 1.7;
        }
        #overall-score { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 20px; text-align: center; margin: 20px 0; }
        #overall-score .score { font-size: 3.5em; font-weight: 800; }
        .history-item { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px; padding: 15px; margin: 10px 0; display: flex; align-items: center; gap: 12px; }
        .history-info { flex: 1; cursor: pointer; }
        .history-date { font-size: 0.85em; color: #999; margin-bottom: 4px; }
        .history-stats { font-size: 0.9em; color: #555; }
        .history-score { font-size: 1.8em; font-weight: 700; color: #667eea; min-width: 50px; text-align: center; }
        .delete-btn { background: #e74c3c; color: white; border: none; width: 50px; height: 50px; border-radius: 12px; font-size: 1.5em; cursor: pointer; flex-shrink: 0; }
        .delete-btn:active { transform: scale(0.95); background: #c0392b; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
        .tips-box { 
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); 
            border: 2px solid #81c784;
            border-radius: 12px; 
            padding: 18px; 
            margin: 20px 0;
            text-align: right;
        }
        .tips-box h3 { 
            color: #2e7d32; 
            margin-bottom: 12px; 
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tip-item { 
            color: #1b5e20; 
            margin: 10px 0; 
            padding: 8px 12px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
            font-size: 0.95em;
            line-height: 1.5;
        }
        .tip-icon { font-size: 1.2em; }
    </style>
</head>
<body>
    <div class="container">
        <div id="home-page" class="page active">
            <h1>ğŸ¤ OnCam Coach</h1>
            <div class="subtitle">
                <div class="subtitle-question">×™×© ×œ×š ×‘×§×¨×•×‘ ×¨××™×•×Ÿ, ××•×“×™×©'×Ÿ, ×”×¨×¦××”, ×¤×™×¥' ?</div>
                <div class="subtitle-answer">×× ×™ ×›××Ÿ ×‘×©×‘×™×œ×š.</div>
            </div>
            <p style="text-align:center; color:#999; font-size:0.8em; margin-bottom:20px;">×’×¨×¡×” 2.2 â€¢ ×¢× ×˜×™×¤×™×</p>
            <button class="btn btn-primary" onclick="goToCamera()">ğŸš€ ×”×ª×—×œ ××™××•×Ÿ ×—×“×©</button>
            <button class="btn btn-secondary" onclick="goToHistory()">ğŸ“Š ×”×™×¡×˜×•×¨×™×™×ª ××™××•× ×™×</button>
        </div>

        <div id="camera-page" class="page">
            <h1>ğŸ¬ ×”×§×œ×˜×”</h1>
            
            <div class="tips-box" id="tips-box">
                <h3><span class="tip-icon">ğŸ¬</span> ×˜×™×¤×™× ×œ×”×§×œ×˜×” ××•×¦×œ×—×ª</h3>
                <div class="tip-item"><span class="tip-icon">ğŸ¯</span> ×“×‘×¨×• ×‘×§×¦×‘ × ×¢×™×. ×œ× ×¦×¨×™×š ×œ×¨×•×¥, ×•×’× ×œ× ×œ×”××˜. ×¤×©×•×˜ ×œ×“×‘×¨.</div>
                <div class="tip-item"><span class="tip-icon">ğŸ‘ï¸</span> ×”×¡×ª×›×œ×• ×œ××¦×œ××”, ×›××™×œ×• ××™×©×”×• ×™×•×©×‘ ××•×œ×›× ×•××§×©×™×‘ ×¨×§ ×œ×›×.</div>
                <div class="tip-item"><span class="tip-icon">ğŸ¤</span> ×“×‘×¨×• ×‘×¨×•×¨, ×¢× × ×™××” ×©×œ × ×—×™×©×•×ª ×•××•×¤×˜×™××™×•×ª. ×›×š ×”××¡×¨ ×¢×•×‘×¨ ×˜×•×‘ ×™×•×ª×¨.</div>
                <div class="tip-item"><span class="tip-icon">ğŸ™‚</span> ×ª× ×• ×œ×¤× ×™× ×œ×”×©×ª×ª×£ ×‘×“×™×‘×•×¨ ×•×“××’×• ×©×”×Ÿ ×™×”×™×• ××•××¨×•×ª. ××•×¨ ×˜×•×‘ ××©×¤×¨ ××ª ××™×›×•×ª ×”×¦×™×œ×•× ×•×”× ×•×›×—×•×ª.</div>
                <div class="tip-item"><span class="tip-icon">ğŸ’ª</span> ×“×‘×¨×• ×œ×¤×—×•×ª ×—×¦×™ ×“×§×” ×¨×¦×•×¤×”, ×›×“×™ ×œ×”×™×›× ×¡ ×œ×–×¨×™××”.</div>
            </div>
            
            <div id="video-container">
                <video id="video" autoplay muted playsinline></video>
                <div id="timer">00:00</div>
                <div id="eye-contact">ğŸ‘ï¸ ×§×©×¨ ×¢×™×Ÿ</div>
                <div id="stats-box">
                    <div class="stat-row"><span class="stat-label">â±ï¸ ×–××Ÿ</span><span class="stat-value" id="stats-time">00:00</span></div>
                    <div class="stat-row"><span class="stat-label">ğŸ’¬ ××™×œ×™×</span><span class="stat-value" id="stats-words">0</span></div>
                    <div class="stat-row"><span class="stat-label">ğŸ¯ ×§×¦×‘</span><span class="stat-value"><span id="wpm-display">0</span></span></div>
                </div>
            </div>
            <div id="feedback"></div>
            <div class="transcript-box"><p id="transcript-text" style="color: #999;">×”×ª××œ×•×œ ×™×•×¤×™×¢ ×›××Ÿ...</p></div>
            <button id="start-btn" class="btn btn-primary" onclick="startRecording()">âºï¸ ×”×ª×—×œ ×”×§×œ×˜×”</button>
            <button id="stop-btn" class="btn btn-danger" onclick="stopRecording()" style="display:none;">â¹ï¸ ×¢×¦×•×¨ ×”×§×œ×˜×”</button>
            <button class="btn btn-secondary" onclick="goHome()">ğŸ  ×—×–×•×¨</button>
        </div>

        <div id="results-page" class="page">
            <h1>ğŸ† ×ª×•×¦××•×ª</h1>
            <div id="overall-score">
                <div style="font-size: 1.2em; margin-bottom: 10px;">×¦×™×•×Ÿ ×›×œ×œ×™</div>
                <div class="score" id="final-score">0</div>
                <div style="margin-top: 5px;">××ª×•×š 100</div>
            </div>
            <div class="results-grid">
                <div class="result-card"><div class="result-label">××™×œ×™× ×œ×“×§×”</div><div class="result-value" id="result-wpm">0</div></div>
                <div class="result-card"><div class="result-label">×¡×”"×› ××™×œ×™×</div><div class="result-value" id="result-words">0</div></div>
                <div class="result-card"><div class="result-label">×–××Ÿ</div><div class="result-value" id="result-time">0:00</div></div>
                <div class="result-card"><div class="result-label">×§×©×¨ ×¢×™×Ÿ</div><div class="result-value" id="result-eye" style="font-size: 1.5em;">-</div></div>
            </div>
            
            <div class="summary-box">
                <div class="summary-title">ğŸ’¬ ×¡×™×›×•× ×”××™××•×Ÿ</div>
                <div class="summary-text" id="summary-text"></div>
            </div>
            
            <div class="transcript-box" style="max-height: 200px;"><strong>×ª××œ×•×œ ××œ×:</strong><br><span id="result-transcript"></span></div>
            <button class="btn btn-primary" onclick="reRecord()">ğŸ”„ ××™××•×Ÿ × ×•×¡×£</button>
            <button class="btn btn-secondary" onclick="goToHistory()">ğŸ“Š ×”×™×¡×˜×•×¨×™×”</button>
            <button class="btn btn-secondary" onclick="goHome()">ğŸ  ×—×–×•×¨ ×œ×‘×™×ª</button>
        </div>

        <div id="history-page" class="page">
            <h1>ğŸ“Š ×”×™×¡×˜×•×¨×™×”</h1>
            <div id="history-list"></div>
            <button class="btn btn-secondary" onclick="goHome()">ğŸ  ×—×–×•×¨</button>
        </div>
    </div>

    <script>
        let stream, mediaRecorder, recognition, timerInterval, eyeInterval;
        let startTime, transcript = '', wordCount = 0, currentWPM = 0;
        let wordCountHistory = [];
        let eyeScore = 100, eyeHistory = [];
        let lastWords = 0, silenceCount = 0;

        function goToCamera() { 
            show('camera-page'); 
            setupCamera();
            // ×”×¦×’ ×˜×™×¤×™×
            document.getElementById('tips-box').style.display = 'block';
        }
        function goHome() {
            stopRecording();
            if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
            show('home-page');
        }
        function goToHistory() { show('history-page'); loadHistory(); }
        function reRecord() { 
            // ×”××¦×œ××” ×›×‘×¨ ×¤×•×¢×œ×ª! ×¨×§ × ×§×” ×”×›×œ ×•×ª×ª×—×™×œ ××—×“×©
            resetRecording();
            show('camera-page');
            // × ×§×” feedback
            const feedbackEl = document.getElementById('feedback');
            feedbackEl.classList.remove('show', 'good', 'warning', 'error');
            feedbackEl.textContent = '';
            // ×”×¦×’ ×˜×™×¤×™×
            document.getElementById('tips-box').style.display = 'block';
        }
        function show(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        async function setupCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: true });
                document.getElementById('video').srcObject = stream;
                console.log('[CAMERA] âœ… Ready');
            } catch (err) {
                console.error('[CAMERA] âŒ Error:', err);
                alert('×œ× × ×™×ª×Ÿ ×œ×’×©×ª ×œ××¦×œ××”: ' + err.message);
                goHome();
            }
        }

        function startRecording() {
            if (!stream) return alert('×”××ª×Ÿ ×œ××¦×œ××”...');
            
            console.log('[RECORDING] â–¶ï¸ Starting...');
            transcript = ''; wordCount = 0; wordCountHistory = []; currentWPM = 0;
            eyeScore = 100; eyeHistory = []; lastWords = 0; silenceCount = 0;
            
            // ×”×¡×ª×¨ ×˜×™×¤×™×
            document.getElementById('tips-box').style.display = 'none';
            
            // × ×§×” feedback ×××™××•×Ÿ ×§×•×“×
            const feedbackEl = document.getElementById('feedback');
            feedbackEl.classList.remove('show', 'good', 'warning', 'error');
            feedbackEl.textContent = '';
            
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'block';
            document.getElementById('stats-box').style.display = 'block';
            document.getElementById('eye-contact').style.display = 'block';
            document.getElementById('transcript-text').innerHTML = '××§×œ×™×˜...';
            document.getElementById('transcript-text').style.color = '#333';
            
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            
            // ×§×©×¨ ×¢×™×Ÿ - ×—×›× ×•××“×•×™×§!
            eyeInterval = setInterval(checkEyeContact, 2000);
            
            try {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                console.log('[VIDEO] âœ… Recording');
            } catch(e) { console.error('[VIDEO] âŒ', e); }
            
            startSpeech();
        }

        function stopRecording() {
            console.log('[RECORDING] â¹ï¸ Stopping...');
            clearInterval(timerInterval);
            clearInterval(eyeInterval);
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            if (recognition) { recognition.stop(); recognition = null; }
            
            document.getElementById('stats-box').style.display = 'none';
            document.getElementById('eye-contact').style.display = 'none';
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('stop-btn').style.display = 'none';
            
            // ×”×¦×’ ×˜×™×¤×™× ××—×“×©
            document.getElementById('tips-box').style.display = 'block';
            
            // ××¤×¡ eyeData ×œ××™××•×Ÿ ×”×‘×
            window.eyeData = null;
            
            setTimeout(showResults, 500);
        }

        function resetRecording() {
            transcript = ''; wordCount = 0;
            document.getElementById('transcript-text').textContent = '×”×ª××œ×•×œ ×™×•×¤×™×¢ ×›××Ÿ...';
            document.getElementById('transcript-text').style.color = '#999';
            document.getElementById('timer').textContent = '00:00';
        }

        function startSpeech() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) {
                console.error('[SPEECH] âŒ Not supported');
                showFeedback('×–×™×”×•×™ ×“×™×‘×•×¨ ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ', 'error');
                return;
            }
            
            recognition = new SR();
            recognition.lang = 'he-IL';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            recognition.onstart = () => console.log('[SPEECH] âœ… Started');
            
            recognition.onresult = (e) => {
                let final = '', interim = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    const text = e.results[i][0].transcript;
                    if (e.results[i].isFinal) {
                        final += text + ' ';
                    } else {
                        interim += text;
                    }
                }
                
                if (final) {
                    transcript += final;
                }
                
                // ×¢×“×›×•×Ÿ ××¡×¤×¨ ××™×œ×™× ××™×™×“×™ - ×›×•×œ×œ interim!
                const tempTranscript = transcript + ' ' + interim;
                wordCount = tempTranscript.trim().split(/\s+/).filter(w => w.length > 0).length;
                console.log('[SPEECH] ğŸ’¬ Words:', wordCount, '(interim included)');
                
                const display = transcript + (interim ? '<i style="color:#999;opacity:0.7">' + interim + '</i>' : '');
                document.getElementById('transcript-text').innerHTML = display || '××§×œ×™×˜...';
                
                // ×¢×“×›×•×Ÿ ××™×™×“×™ ×©×œ ×”×ª×¦×•×’×”
                document.getElementById('stats-words').textContent = wordCount;
            };
            
            recognition.onerror = (e) => {
                if (e.error !== 'no-speech') console.error('[SPEECH] âš ï¸', e.error);
            };
            
            recognition.onend = () => {
                console.log('[SPEECH] â¸ï¸ Ended');
                if (timerInterval) {
                    setTimeout(() => {
                        try { recognition.start(); console.log('[SPEECH] ğŸ”„ Restarting...'); }
                        catch(e) { console.error('[SPEECH] âŒ Restart failed:', e); }
                    }, 100);
                }
            };
            
            try { recognition.start(); }
            catch(e) { console.error('[SPEECH] âŒ Start error:', e); }
        }

        function checkEyeContact() {
            const video = document.getElementById('video');
            const indicator = document.getElementById('eye-contact');
            
            if (!video.videoWidth) return;
            
            // ×¦×™×œ×•× ×¤×¨×™×™× ×§×˜×Ÿ
            const canvas = document.createElement('canvas');
            canvas.width = 80;
            canvas.height = 60;
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            
            // ×—×™×©×•×‘ ×‘×”×™×¨×•×ª ×××•×¦×¢×ª - ×–×” ×”×¤×¨××˜×¨ ×”××¨×›×–×™!
            let sum = 0, pixels = 0;
            for (let i = 0; i < data.length; i += 4) {
                sum += (data[i] + data[i+1] + data[i+2]) / 3;
                pixels++;
            }
            const avgBrightness = sum / pixels;
            
            // ×—×™×©×•×‘ ×©×•× ×•×ª (×›××” ×©×™× ×•×™ ×™×© ×‘×ª××•× ×”)
            let variance = 0;
            for (let i = 0; i < data.length; i += 4) {
                const pixelBright = (data[i] + data[i+1] + data[i+2]) / 3;
                variance += Math.pow(pixelBright - avgBrightness, 2);
            }
            variance = variance / pixels;
            
            // ××ª×—×•×œ
            if (!window.eyeData) {
                window.eyeData = {
                    lastBrightness: avgBrightness,
                    lastVariance: variance,
                    brightnessHistory: [avgBrightness],
                    frozenCount: 0,
                    lastAlert: 0
                };
                indicator.textContent = 'ğŸ‘ï¸ ××ª×—×™×œ...';
                indicator.className = '';
                eyeHistory.push(100);
                return;
            }
            
            // ×©××™×¨×ª ×”×™×¡×˜×•×¨×™×™×ª ×‘×”×™×¨×•×ª (3 ×“×’×™××•×ª - ××’×™×‘ ××”×¨ ×™×•×ª×¨)
            window.eyeData.brightnessHistory.push(avgBrightness);
            if (window.eyeData.brightnessHistory.length > 3) {
                window.eyeData.brightnessHistory.shift();
            }
            
            // ×—×™×©×•×‘ ×××•×¦×¢ ×‘×”×™×¨×•×ª
            const avgHistBrightness = window.eyeData.brightnessHistory.reduce((a,b) => a+b, 0) / window.eyeData.brightnessHistory.length;
            
            // ×—×™×©×•×‘ ×©×™× ×•×™ ×‘×‘×”×™×¨×•×ª ×•×‘×©×•× ×•×ª
            const brightChange = Math.abs(avgBrightness - window.eyeData.lastBrightness);
            const varChange = Math.abs(variance - window.eyeData.lastVariance);
            const movement = brightChange + (varChange / 100);
            
            console.log(`[EYE] ğŸ’¡ Bright: ${avgBrightness.toFixed(0)} (avg: ${avgHistBrightness.toFixed(0)}), Movement: ${movement.toFixed(1)}, Var: ${variance.toFixed(0)}`);
            
            // *** ×œ×•×’×™×§×” ××›×•×™×œ×ª ××—×“×© - ×¡×£ × ××•×š ×™×•×ª×¨ ***
            
            // ×¨××ª 1: ×‘×“×™×§×ª ××•×¨ (×§×¨×™×˜×™!)
            if (avgHistBrightness < 45) {
                // ××•×¨ ×××“ ×—×œ×© - ××“×•×
                eyeScore = Math.max(0, eyeScore - 10);
                indicator.textContent = 'ğŸŒ‘ ××•×¨ ×—×œ×© ×××“';
                indicator.className = 'error';
                
                const now = Date.now();
                if (now - window.eyeData.lastAlert > 12000) {
                    showFeedback('×”×ª××•×¨×” ×—×œ×©×” ××“×™ - ×”×•×¡×£ ××•×¨! ğŸ’¡', 'error');
                    window.eyeData.lastAlert = now;
                }
            }
            else if (avgHistBrightness < 70) {
                // ××•×¨ ×—×œ×© - ×›×ª×•×
                eyeScore = Math.max(0, eyeScore - 5);
                indicator.textContent = 'ğŸ’¡ ××•×¨ ×—×œ×©';
                indicator.className = 'warning';
                
                const now = Date.now();
                if (now - window.eyeData.lastAlert > 18000) {
                    showFeedback('×›×“××™ ×œ×”×•×¡×™×£ ××•×¨ ğŸ’¡', 'warning');
                    window.eyeData.lastAlert = now;
                }
            }
            else if (avgHistBrightness < 95) {
                // ××•×¨ ×‘×™× ×•× ×™ - ×¦×”×•×‘
                eyeScore = Math.min(100, eyeScore + 1);
                indicator.textContent = 'ğŸ‘ï¸ ××•×¨ ×¡×‘×™×¨';
                indicator.className = 'warning';
            }
            // ×¨××ª 2: ×‘×“×™×§×ª ×ª× ×•×¢×” (×¨×§ ×× ×™×© ××•×¨ ××¡×¤×™×§)
            else if (movement < 0.8 && variance < 200) {
                // ×§×™×¤××•×Ÿ ××•×—×œ×˜ - ×™×¦× ××”××¡×š
                window.eyeData.frozenCount++;
                
                if (window.eyeData.frozenCount >= 4) {
                    eyeScore = Math.max(0, eyeScore - 10);
                    indicator.textContent = 'âŒ ×—×–×•×¨ ×œ××¡×š!';
                    indicator.className = 'error';
                    
                    const now = Date.now();
                    if (now - window.eyeData.lastAlert > 12000) {
                        showFeedback('× ×¨××” ×©×™×¦××ª ××”××¡×š! ğŸ‘€', 'error');
                        window.eyeData.lastAlert = now;
                    }
                }
            }
            else if (movement < 1.5) {
                // ×ª× ×•×¢×” ×§×˜× ×”
                window.eyeData.frozenCount = Math.max(0, window.eyeData.frozenCount - 1);
                eyeScore = Math.min(100, eyeScore + 1);
                indicator.textContent = 'ğŸ‘ï¸ ×§×©×¨ ×¢×™×Ÿ';
                indicator.className = '';
            }
            else {
                // ×ª× ×•×¢×” ×˜×•×‘×” + ××•×¨ ×˜×•×‘ = ××¦×•×™×Ÿ!
                window.eyeData.frozenCount = 0;
                eyeScore = Math.min(100, eyeScore + 2);
                indicator.textContent = 'âœ… ××¦×•×™×Ÿ!';
                indicator.className = '';
            }
            
            window.eyeData.lastBrightness = avgBrightness;
            window.eyeData.lastVariance = variance;
            eyeHistory.push(eyeScore);
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('timer').textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
            
            calcWPM(elapsed);
            updateStats(elapsed);
            if (elapsed % 5 === 0) checkFeedback(elapsed);
        }

        function calcWPM(elapsed) {
            wordCountHistory.push({ time: elapsed, words: wordCount });
            wordCountHistory = wordCountHistory.filter(e => e.time > elapsed - 30);
            
            const window15 = wordCountHistory.filter(e => e.time >= elapsed - 15);
            
            if (window15.length >= 2 && elapsed >= 10) {
                const old = window15[0];
                const cur = window15[window15.length - 1];
                const timeDiff = cur.time - old.time;
                const wordDiff = cur.words - old.words;
                if (timeDiff > 0 && wordDiff > 0) {
                    currentWPM = Math.round((wordDiff / timeDiff) * 60);
                }
            } else if (elapsed >= 2 && wordCount > 0) {
                currentWPM = Math.round((wordCount / elapsed) * 60);
            } else {
                currentWPM = 0;
            }
            
            console.log(`[WPM] â±ï¸ ${elapsed}s | ğŸ’¬ ${wordCount} words | ğŸ¯ ${currentWPM} WPM`);
        }

        function updateStats(elapsed) {
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('stats-time').textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
            document.getElementById('stats-words').textContent = wordCount;
            
            const wpm = document.getElementById('wpm-display');
            wpm.textContent = currentWPM;
            wpm.style.color = (currentWPM >= 120 && currentWPM <= 180) ? '#4CAF50' : (currentWPM > 0 ? '#FF9800' : '#999');
        }

        function checkFeedback(elapsed) {
            if (elapsed < 10) return;
            
            if (wordCount === lastWords) silenceCount++;
            else { silenceCount = 0; lastWords = wordCount; }
            
            if (silenceCount > 8 && wordCount > 20) {
                showFeedback('×©×ª×™×§×” ××¨×•×›×” - ×”××©×š ×œ×“×‘×¨! ğŸ¤', 'error');
            } else if (currentWPM > 0 && currentWPM < 100) {
                showFeedback(`×§×¦×‘ ××™×˜×™ (${currentWPM}) - ×”××¥ ×§×¦×ª âš¡`, 'warning');
            } else if (currentWPM > 200) {
                showFeedback(`×§×¦×‘ ××”×™×¨ (${currentWPM}) - ×”××˜ ××¢×˜ ğŸ¢`, 'warning');
            } else if (currentWPM >= 120 && currentWPM <= 180) {
                showFeedback(`××¦×•×™×Ÿ! (${currentWPM} WPM) ğŸ¯`, 'good');
            }
        }

        function showFeedback(msg, type) {
            const f = document.getElementById('feedback');
            f.textContent = msg;
            f.className = 'show ' + type;
            if (type === 'good') setTimeout(() => f.classList.remove('show'), 3000);
        }

        function showResults() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const mins = elapsed / 60;
            const wpm = mins > 0 ? Math.round(wordCount / mins) : 0;
            
            let score = 0;
            if (wpm >= 120 && wpm <= 180) score += 50;
            else if (wpm >= 100) score += 40;
            else if (wpm >= 80) score += 30;
            else if (wpm > 0) score += 20;
            
            if (wordCount >= 100) score += 30;
            else if (wordCount >= 50) score += 20;
            else if (wordCount >= 20) score += 10;
            else if (wordCount > 0) score += 5;
            
            if (elapsed >= 60) score += 20;
            else if (elapsed >= 30) score += 10;
            else if (elapsed >= 10) score += 5;
            
            const avgEye = eyeHistory.length > 0 ? Math.round(eyeHistory.reduce((a,b)=>a+b,0) / eyeHistory.length) : 100;
            const eyeLabel = avgEye >= 80 ? '××¦×•×™×Ÿ âœ¨' : avgEye >= 60 ? '×˜×•×‘ ğŸ‘' : avgEye >= 40 ? '×‘×¡×“×¨ ğŸ‘Œ' : '×œ× ×–××™×Ÿ';
            
            document.getElementById('final-score').textContent = score;
            document.getElementById('result-wpm').textContent = wpm;
            document.getElementById('result-words').textContent = wordCount;
            document.getElementById('result-time').textContent = `${Math.floor(elapsed/60)}:${String(elapsed%60).padStart(2,'0')}`;
            document.getElementById('result-eye').textContent = eyeLabel;
            document.getElementById('result-transcript').textContent = transcript || '××™×Ÿ ×ª××œ×•×œ';
            
            // ×™×¦×™×¨×ª ×¡×™×›×•× ××™×œ×•×œ×™
            let summary = generateSummary(wpm, wordCount, elapsed, avgEye);
            document.getElementById('summary-text').textContent = summary;
            
            saveHistory(score, wpm, wordCount, elapsed, eyeLabel, transcript);
            show('results-page');
            
            console.log(`[RESULTS] ğŸ† Score: ${score} | ğŸ¯ ${wpm} WPM | ğŸ’¬ ${wordCount} words | â±ï¸ ${elapsed}s`);
        }
        
        function generateSummary(wpm, words, time, eyeScore) {
            let parts = [];
            
            // ×§×¦×‘ ×“×™×‘×•×¨
            if (wpm >= 120 && wpm <= 180) {
                parts.push('×“×™×‘×¨×ª ×‘×§×¦×‘ ××¦×•×™×Ÿ ×•× ×¢×™×');
            } else if (wpm > 180) {
                parts.push('×“×™×‘×¨×ª ××”×¨ ××“×™ - ×›×“××™ ×œ×”××˜ ×§×¦×ª');
            } else if (wpm < 100 && wpm > 0) {
                parts.push('×“×™×‘×¨×ª ×œ××˜ - × ×¡×” ×œ×”××™×¥ ××¢×˜');
            } else if (wpm >= 100) {
                parts.push('×§×¦×‘ ×”×“×™×‘×•×¨ ×”×™×” ×¡×‘×™×¨');
            }
            
            // ×ª××•×¨×” ×•×§×©×¨ ×¢×™×Ÿ - ×‘×“×™×§×” ××“×•×™×§×ª!
            if (eyeScore < 50) {
                parts.push('×”×ª××•×¨×” ×”×™×™×ª×” ×—×œ×©×” ×××“ ××• ×©× ×¢×ª ××”××¡×š');
            } else if (eyeScore < 70) {
                parts.push('×”×ª××•×¨×” ×”×™×™×ª×” ×—×œ×©×” - ×›×“××™ ×œ×©×¤×¨');
            } else if (eyeScore >= 85) {
                parts.push('×ª××•×¨×” ××¦×•×™× ×ª ×•×§×©×¨ ×¢×™×Ÿ ×˜×•×‘');
            } else {
                parts.push('×ª××•×¨×” ×¡×‘×™×¨×”');
            }
            
            // ××•×¨×š ×•×©×˜×£
            if (words < 20) {
                parts.push('× ×¡×” ×œ×“×‘×¨ ×™×•×ª×¨ ×‘×¤×¢× ×”×‘××”');
            } else if (words >= 100) {
                parts.push('××•×¨×š ××¦×•×™×Ÿ - × ×©××¢ ×©×˜×•×£ ×•×¨×¦×™×£');
            } else if (time < 30) {
                parts.push('××™××•×Ÿ ×§×¦×¨ - × ×¡×” ×œ×“×‘×¨ ×™×•×ª×¨ ×–××Ÿ');
            }
            
            // ×©×›× ×•×¢ ×•×× ×¨×’×™×”
            if (wpm > 150 && words > 50) {
                parts.push('× ×©××¢ ×©×™×© ×× ×¨×’×™×”');
            } else if (wpm < 110) {
                parts.push('× ×¡×” ×œ×”×›× ×™×¡ ×™×•×ª×¨ ×× ×¨×’×™×” ×•×©×›× ×•×¢');
            }
            
            return parts.join(', ') + '.';
        }

        function saveHistory(score, wpm, words, time, eye, trans) {
            let hist = JSON.parse(localStorage.getItem('oncam') || '[]');
            const session = { id: Date.now(), date: new Date().toLocaleString('he-IL'), score, wpm, words, time, eye, trans };
            hist.unshift(session);
            if (hist.length > 50) hist = hist.slice(0, 50);
            localStorage.setItem('oncam', JSON.stringify(hist));
            console.log('[HISTORY] ğŸ’¾ Saved:', session);
            console.log('[HISTORY] ğŸ“Š Total sessions:', hist.length);
        }

        function loadHistory() {
            const hist = JSON.parse(localStorage.getItem('oncam') || '[]');
            const list = document.getElementById('history-list');
            
            console.log('[HISTORY] ğŸ“‚ Loading... Found:', hist.length, 'sessions');
            
            if (hist.length === 0) {
                list.innerHTML = '<div class="empty-state"><div style="font-size:3em">ğŸ“­</div><div>××™×Ÿ ××™××•× ×™× ×©××•×¨×™×</div><div style="font-size:0.9em;margin-top:10px;color:#bbb">×”×¨×¥ ××™××•×Ÿ ×¨××©×•×Ÿ ×›×“×™ ×œ×”×ª×—×™×œ</div></div>';
                return;
            }
            
            list.innerHTML = hist.map((h, idx) => `
                <div class="history-item">
                    <button class="delete-btn" onclick="deleteHistory(${h.id}, event)">ğŸ—‘ï¸</button>
                    <div class="history-info" onclick="viewHistory(${h.id})">
                        <div class="history-date">${h.date}</div>
                        <div class="history-stats">${h.wpm} WPM Â· ${h.words} ××™×œ×™× Â· ${Math.floor(h.time/60)}:${String(h.time%60).padStart(2,'0')}</div>
                    </div>
                    <div class="history-score">${h.score}</div>
                </div>
            `).join('');
            
            console.log('[HISTORY] âœ… Displayed', hist.length, 'items');
        }

        function deleteHistory(id, event) {
            event.stopPropagation();
            if (!confirm('×œ××—×•×§ ××™××•×Ÿ ×–×”?')) return;
            
            let hist = JSON.parse(localStorage.getItem('oncam') || '[]');
            const before = hist.length;
            hist = hist.filter(h => h.id !== id);
            localStorage.setItem('oncam', JSON.stringify(hist));
            
            console.log('[HISTORY] ğŸ—‘ï¸ Deleted session', id, '| Before:', before, 'â†’ After:', hist.length);
            loadHistory();
        }

        function viewHistory(id) {
            const hist = JSON.parse(localStorage.getItem('oncam') || '[]');
            const h = hist.find(x => x.id === id);
            if (!h) return console.error('[HISTORY] âŒ Session not found:', id);
            
            console.log('[HISTORY] ğŸ‘ï¸ Viewing:', h);
            
            document.getElementById('final-score').textContent = h.score;
            document.getElementById('result-wpm').textContent = h.wpm;
            document.getElementById('result-words').textContent = h.words;
            document.getElementById('result-time').textContent = `${Math.floor(h.time/60)}:${String(h.time%60).padStart(2,'0')}`;
            document.getElementById('result-eye').textContent = h.eye;
            document.getElementById('result-transcript').textContent = h.trans || '××™×Ÿ ×ª××œ×•×œ';
            
            show('results-page');
        }

        // ×˜×¢×™× ×” ××•×˜×•××˜×™×ª ×©×œ ×”×™×¡×˜×•×¨×™×” ×‘×”×¤×¢×œ×”
        console.log('[APP] ğŸš€ OnCam Coach loaded');
        console.log('[APP] ğŸ“Š Checking localStorage...');
        const savedSessions = JSON.parse(localStorage.getItem('oncam') || '[]');
        console.log('[APP] ğŸ’¾ Found', savedSessions.length, 'saved sessions');
    </script>
</body>
</html>
